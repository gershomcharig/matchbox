# Matchbox Development Progress

This file tracks accomplishments, failures, and learnings across execution loops.
Read this file at the start of each session to maintain context and avoid repeating mistakes.

---

## Current Status
**Last Updated**: 2026-01-21
**Current Phase**: Phase 2 In Progress
**Next Step**: Phase 2.9 - Logout

---

## Completed Tasks

### Phase 0: Project Setup (COMPLETE)
- [x] 0.1 Initialize Next.js with App Router (commit: 1b205b7)
- [x] 0.2 Tailwind CSS configured and tested
- [x] 0.3 Environment & Git setup (.env.local.example created)
- [x] 0.4 Project structure created (components/, lib/, app/)
- [x] 0.5 Supabase client setup (lib/supabase.ts) (commit: 05922ea)
- [x] 0.6-0.9 Database schema created:
  - settings table (key, value)
  - collections table (id, name, color, icon, timestamps)
  - places table (all fields per schema)
  - tags table (id, name)
  - place_tags junction table (place_id, tag_id)

### Phase 1: Map Foundation (COMPLETE)
- [x] 1.1 Mapbox Setup - installed mapbox-gl@3.18.0 and react-map-gl@8.1.0
- [x] 1.2 Basic Map component - components/Map.tsx, centered on London (51.5074, -0.1278)
- [x] 1.3 Map styling - using mapbox://styles/mapbox/light-v11, fills viewport
- [x] 1.4 Responsive layout shell - components/Layout.tsx with flex layout
- [x] 1.5 Empty state overlay - components/EmptyState.tsx with prompt message

### Phase 2: Password Protection (IN PROGRESS)
- [x] 2.1 Password Setup Screen - src/app/setup/page.tsx
  - Form with password and confirm password inputs
  - Show/hide password toggle using lucide-react icons
  - Validation: minimum 8 characters, passwords must match
  - Glass-morphism design with amber accent color
  - Installed lucide-react package
- [x] 2.2 Password Hashing - src/lib/auth.ts
  - Using Web Crypto API with PBKDF2 (no external dependencies)
  - 100,000 iterations, SHA-256 hash, 256-bit key
  - Random 16-byte salt per password
  - Hash format: salt:hash (hex encoded)
  - Constant-time comparison to prevent timing attacks
  - Functions: hashPassword(), verifyPassword()
- [x] 2.3 Store Password Hash - src/app/setup/actions.ts
  - Server action setupPassword() hashes and saves to settings table
  - Server action isPasswordSet() checks if password exists
  - Setup form connected to server action with error handling
  - Redirects to main page on success
- [x] 2.4 Password Entry Screen - src/app/login/page.tsx
  - Login form with password input and submit button
  - Show/hide password toggle
  - Error display for failed login attempts
  - Matches setup page design aesthetic
- [x] 2.5 Password Verification - src/app/login/actions.ts
  - Server action verifyPasswordAction() fetches hash from settings table
  - Uses verifyPassword() from lib/auth.ts for constant-time comparison
  - Returns success/error object to client
  - Login form wired to server action with error handling
  - Incorrect password shows user-friendly error message
  - Correct password redirects to main page (session token to be added in 2.6)
- [x] 2.6 Session Token - src/lib/auth.ts
  - Added generateSessionToken() using crypto.getRandomValues (32 bytes, 256 bits)
  - Converts to URL-safe base64 format
  - Added setSessionToken(), getSessionToken(), clearSessionToken() for localStorage
  - Added isAuthenticated() helper to check if session exists
  - Login page now generates and stores token on successful authentication
  - Token is cryptographically secure and collision-resistant
- [x] 2.7 Auth State Check - src/lib/auth.ts
  - Already implemented in Phase 2.6 with isAuthenticated() function
  - Checks if session token exists in localStorage
  - Returns boolean for quick auth status checks
- [x] 2.8 Route Protection - src/components/AuthGuard.tsx
  - Created AuthGuard component to protect routes
  - Checks if password is set via isPasswordSet() server action
  - Redirects to /setup if no password exists
  - Checks authentication status via isAuthenticated()
  - Redirects to /login if not authenticated
  - Shows loading spinner during auth check
  - Wrapped root layout with AuthGuard for app-wide protection
  - Public routes (/setup, /login) bypass auth check

---

## Decisions Made

### Database
- Using Supabase (PostgreSQL) with free tier
- All tables created via Supabase dashboard/SQL editor
- Foreign key from places.collection_id â†’ collections.id
- Soft delete via deleted_at timestamp on places

### Project Structure
- /src/app - Next.js App Router pages
- /src/components - React components
- /src/lib - Utility functions (supabase.ts, etc.)
- /docs - Documentation (roadmap.md, PRD.md, progress.txt)

### Map Implementation
- Using react-map-gl v8 with subpath import: `react-map-gl/mapbox`
- Map style: mapbox://styles/mapbox/light-v11 (clean, minimal)
- Initial zoom level: 11

### UI/Design
- Minimal, clean aesthetic
- Empty state overlay positioned at bottom center
- Glass-morphism style card (bg-white/95 with backdrop-blur)
- Responsive breakpoint at lg (1024px) for desktop side panel

---

## Blockers Encountered

### 2026-01-21 - react-map-gl import issue with Turbopack
**Problem**: Build failed with "Module not found: Can't resolve 'react-map-gl'"
**Why it failed**: react-map-gl v8 uses subpath exports, no default export
**Solution**: Changed import from `react-map-gl` to `react-map-gl/mapbox`

---

## Failed Approaches

### 2026-01-21 - Default react-map-gl import
**Problem**: `import MapGL from 'react-map-gl'` failed in Turbopack
**Why it failed**: react-map-gl v8 restructured exports to use subpaths
**Better approach**: Use `import { Map } from 'react-map-gl/mapbox'` for Mapbox GL

---

## Files Changed Log

### 2026-01-21
- Created: docs/progress.txt
- Modified: CLAUDE.md (added progress tracking instructions)
- Modified: package.json (added mapbox-gl, react-map-gl)
- Created: src/components/Map.tsx
- Created: src/components/Layout.tsx
- Created: src/components/EmptyState.tsx
- Modified: src/app/page.tsx (uses Layout, Map, EmptyState)
- Modified: src/app/layout.tsx (updated title and description)

### 2026-01-21 (Phase 2.1)
- Created: src/app/setup/page.tsx (password setup form)
- Modified: package.json (added lucide-react)

### 2026-01-21 (Phase 2.2)
- Created: src/lib/auth.ts (password hashing utilities)

### 2026-01-21 (Phase 2.3)
- Created: src/app/setup/actions.ts (server actions for password setup)
- Modified: src/app/setup/page.tsx (connected to server action)

### 2026-01-21 (Phase 2.4)
- Created: src/app/login/page.tsx (login form)

### 2026-01-21 (Phase 2.5)
- Created: src/app/login/actions.ts (password verification server action)
- Modified: src/app/login/page.tsx (connected to verifyPasswordAction)

### 2026-01-21 (Phase 2.6)
- Modified: src/lib/auth.ts (added session token functions)
- Modified: src/app/login/page.tsx (generate and store token on login)

### 2026-01-21 (Phase 2.7)
- Already completed in Phase 2.6 (isAuthenticated function)

### 2026-01-21 (Phase 2.8)
- Created: src/components/AuthGuard.tsx (route protection component)
- Modified: src/app/layout.tsx (wrapped with AuthGuard)

---

## Learnings

### Web Crypto API for Password Hashing
- PBKDF2 is available natively in browsers and Node.js via Web Crypto API
- No need for external packages like bcrypt
- Use salt.buffer as ArrayBuffer when passing to crypto.subtle.deriveBits()
- TypeScript strict mode requires explicit type casting for ArrayBuffer

### react-map-gl v8 Breaking Changes
- v8 uses ES module subpath exports
- Import from `react-map-gl/mapbox` for Mapbox GL JS
- Import from `react-map-gl/maplibre` for MapLibre GL JS
- The Map component is named export, not default: `{ Map }`

### Next.js 16 with Turbopack
- Turbopack has stricter module resolution than Webpack
- Some npm packages may need specific import paths
- Build errors often more informative than dev server errors

---

## Next Steps (from roadmap.md)

1. Phase 2.5: Password verification logic
2. Phase 2.6: Session token management
3. Phase 2.7: Auth state check
4. Phase 2.8: Route protection
5. Phase 2.9: Logout functionality

Reference: docs/roadmap.md for full task breakdown
