# Matchbook Development Progress

This file tracks accomplishments, failures, and learnings across execution loops.
Read this file at the start of each session to maintain context and avoid repeating mistakes.

---

## Current Status
**Last Updated**: 2026-01-22
**Current Phase**: Phase 14 COMPLETE
**Next Step**: Phase 15 - Polish & Edge Cases

---

## Completed Tasks

### Phase 14: PWA & Share Sheet (COMPLETE)
- [x] 14.1 Manifest File - public/manifest.json
  - App name, description, theme colors
  - Icons in multiple sizes (192, 512, maskable variants)
  - Apple web app configuration
  - Shortcuts for quick actions
  - Linked in layout.tsx via Next.js Metadata
- [x] 14.2 App Icons - public/icons/
  - Generated via scripts/generate-icons.mjs using sharp
  - icon-192.png, icon-512.png (standard)
  - icon-maskable-192.png, icon-maskable-512.png (safe zone)
  - apple-touch-icon.png (180x180)
  - favicon-16.png, favicon-32.png
  - icon.svg (source file)
- [x] 14.3 Service Worker - public/sw.js
  - Cache-first strategy for static assets
  - Network-first with cache fallback for dynamic content
  - ServiceWorkerRegistration component registers on load
  - Handles update detection
- [x] 14.4 Install Prompt - src/components/InstallPrompt.tsx
  - Listens for beforeinstallprompt event
  - Shows install banner with app benefits
  - Dismissible with 7-day cooldown (stored in localStorage)
  - Hidden when already installed as PWA
- [x] 14.5 Share Target Config - public/manifest.json
  - share_target with action: "/share"
  - Receives title, text, url parameters
  - GET method for simple URL sharing
- [x] 14.6 Share Target Handler - src/app/share/page.tsx
  - Parses shared content from URL params
  - Detects Google Maps URLs in shared text
  - Extracts coordinates and place name
  - Stores place data in sessionStorage
  - Redirects to main app with fromShare=true
  - Main page.tsx picks up shared place and opens AddPlaceModal
  - Error handling for non-Maps links
- [x] 14.7 Paste Button (Mobile) - src/components/Layout.tsx
  - Floating "Paste Link" button at bottom center on mobile
  - Uses navigator.clipboard.readText() API
  - Processes pasted text same as global paste handler
  - Error messages for empty clipboard or non-Maps URLs
  - Gradient styling matching app theme

### Phase 13: Duplicate Detection (COMPLETE)
- [x] 13.1 Check by Coordinates - src/app/actions/places.ts
  - checkDuplicateByCoordinates() function using Haversine formula
  - calculateDistance() helper to compute distance in meters
  - Default threshold of 50 meters
  - Returns existing place if duplicate found
- [x] 13.2 Check by URL - src/app/actions/places.ts
  - checkDuplicateByUrl() function for exact URL matching
  - checkForDuplicates() combines both checks (URL first, then coordinates)
- [x] 13.3 Warning UI - src/components/DuplicateWarningModal.tsx
  - Shows warning with existing place info (name, address, collection)
  - Explains match type (coordinates vs URL)
  - "Add Anyway" and "Cancel" options
  - Integrated into both paste and manual entry flows in Layout.tsx
  - Pending place data stored while waiting for user decision

### Phase 12: Manual Place Entry (COMPLETE)
- [x] 12.1 Add Manually Button - src/components/Layout.tsx
  - MapPinPlus icon button in top bar
  - "Add Place" label on desktop, icon-only on mobile
  - Opens ManualPlaceModal
- [x] 12.2 Manual Entry Form - src/components/ManualPlaceModal.tsx
  - Name field (required) with validation
  - Address field (required) with validation and geocoding hint
  - Notes field (optional) with textarea
  - Tags field (optional) using TagInput component
  - Collection dropdown selector (same as AddPlaceModal)
  - Form validation with touched state tracking
  - Error display for geocoding failures
- [x] 12.3 Geocode Address - src/lib/geocoding.ts
  - forwardGeocode() already implemented in Phase 4
  - Uses OpenStreetMap Nominatim API
  - Returns PlaceInfo with lat, lng, and formatted address
- [x] 12.4 Save Manual Place
  - Creates place with geocoded coordinates
  - Saves notes and tags
  - Shows success toast on completion
  - Refreshes map markers

### Phase 11: Context Menu (COMPLETE)
- [x] 11.1 Desktop Right-Click Menu - src/components/MapMarker.tsx
  - onContextMenu handler on marker div
  - Prevents default browser context menu
  - Passes placeId and cursor position to callback
- [x] 11.2 Mobile Long-Press Menu - src/components/MapMarker.tsx
  - onTouchStart starts 500ms timer
  - onTouchMove cancels if moved > 10px
  - onTouchEnd/onTouchCancel clears timer
  - longPressTriggered ref prevents click after long press
- [x] 11.3 Context Menu Actions - src/components/ContextMenu.tsx
  - Edit: Opens EditPlaceModal with place data
  - Move to: Submenu with all collections (except current)
    - Updates place collection_id on selection
  - Copy address: Copies to clipboard with "Copied!" feedback
  - Get directions: Opens Google Maps directions in new tab
  - Delete: Soft deletes place immediately
  - Context menu positioned with viewport boundary detection
  - Click-outside and Escape key to close
  - Animated entrance with fade-in zoom

### Phase 10: List View (COMPLETE)
- [x] 10.1 View Toggle - src/components/ViewToggle.tsx
  - Map/List toggle button component
  - Styled with amber highlight for active view
  - Icons for Map and List views
  - Positioned bottom-left on mobile, near filter bar on desktop
- [x] 10.2 List View Component - src/components/ListView.tsx
  - Full list view layout with grouping by collection
  - Collection headers with color accent border
  - Empty state when no places to show
- [x] 10.3 List Item Styling
  - Place name, address, and date added
  - Collection color indicator dot
  - Hover and selection states
  - Responsive layout with truncation
- [x] 10.4 Sort by Date
  - Sort dropdown with "Newest first" and "Oldest first" options
  - Uses created_at timestamp for sorting
- [x] 10.5 Sort Alphabetically
  - "A to Z" and "Z to A" sort options
  - Uses localeCompare for proper string sorting
- [x] 10.6 Click to Open Details
  - Clicking list item opens place details panel
  - Selected place highlighted in list
  - Same panel used as map view

### Phase 9: Filtering & Search (COMPLETE)
- [x] 9.1-9.2 Collection Filter - src/components/FilterBar.tsx
  - Collection dropdown with multi-select
  - Shows collection color/icon swatches
  - Filter badge shows active filter count
  - Updates map markers to show only selected collections
- [x] 9.3-9.4 Tag Filter
  - Tag dropdown with multi-select
  - AND logic - place must have ALL selected tags
  - Populates with all tags in the system
  - Filter badge shows active filter count
- [x] 9.5 Clear Filters
  - "Clear" button appears when any filter is active
  - Resets collections, tags, and search query
- [x] 9.6 Clickable Collection
  - Clicking collection in place panel sets collection filter
  - Closes panel and filters map to that collection
- [x] 9.7 Clickable Tags
  - Clicking tag in place panel adds tag to filter
  - Accumulates with existing tag filters (AND logic)
- [x] 9.8-9.9 Search Bar
  - Search input in filter bar
  - Searches place names, addresses, notes, tags, and collection names
  - Clear button to reset search
  - Real-time filtering as you type

### Phase 8: Collections Management (COMPLETE)
- [x] 8.1 Edit Collection UI - src/components/EditCollectionModal.tsx
  - Edit button (pencil icon) on each collection in CollectionsList
  - Modal opens with pre-filled name, color, and icon values
  - Live preview of collection appearance
  - Uses existing ColorPicker and IconPicker components
- [x] 8.2 Save Collection Edits - src/app/actions/collections.ts
  - updateCollection() server action updates name, color, icon
  - UI refreshes collections list and map pins after save
  - Success toast notification
- [x] 8.3-8.4 Delete Collection with Confirmation
  - "Delete this collection" link in edit modal
  - Confirmation dialog shows place count and explains behavior
  - Places moved to default (oldest) collection on delete
  - Cannot delete the only remaining collection
  - deleteCollection() handles moving places before deletion
- [x] 8.5 Focus on Collection - src/components/Map.tsx
  - Focus button (target icon) on each collection with places
  - Clicking zooms map to fit all places in that collection
  - Uses fitBoundsToPlaces() helper with focusCollectionId prop
  - Works on both mobile and desktop
- [x] 8.6 Place Count - src/components/CollectionsList.tsx
  - Shows "X places" below each collection name
  - getCollectionPlaceCounts() server action counts non-deleted places
  - Fetched in parallel with collections for performance

### Phase 7: Edit & Delete Places (COMPLETE)
- [x] 7.1-7.2 Edit Place Modal - src/components/EditPlaceModal.tsx
  - Modal with pre-filled name and notes inputs
  - updatePlace() server action in places.ts
  - Saves changes to database, closes modal, refreshes data
  - Error handling with error message display
- [x] 7.3-7.4 Tag Input Component - src/components/TagInput.tsx
  - Type to add tags, press Enter or comma to confirm
  - Tags displayed as chips with X button to remove
  - Backspace removes last tag when input is empty
  - Maximum 10 tags enforced
  - Server actions: getTags(), getTagsForPlace(), getOrCreateTag(), updatePlaceTags()
  - Tags stored in tags table, relationships in place_tags junction table
- [x] 7.5 Display Tags in Panel - src/components/PlaceDetailsPanel.tsx
  - Tags section with Tag icon
  - Styled as amber chips (matches color scheme)
  - Clickable - logs to console, will filter in Phase 9
  - Fetched separately via getTagsForPlace() when place selected
- [x] 7.6 Change Collection - src/components/EditPlaceModal.tsx
  - Collection dropdown with color/icon preview
  - Fetches collections on modal open
  - Updates collection_id in database on save
- [x] 7.7-7.8 Delete with Soft Delete
  - "Delete this place" link in edit modal
  - Confirmation UI appears on click
  - softDeletePlace() sets deleted_at timestamp
  - Deleted places excluded from normal queries (already implemented)
  - Panel closes after deletion
- [x] 7.9 Trash View - src/app/trash/page.tsx
  - Lists all soft-deleted places with collection info
  - Shows days remaining until permanent deletion (30 days)
  - getDeletedPlaces() server action fetches deleted_at IS NOT NULL
  - Empty state when trash is empty
  - Trash button added to Layout header
- [x] 7.10 Restore from Trash
  - Restore button (green) on each trash item
  - restorePlace() clears deleted_at timestamp
  - Place reappears on map after restore
- [x] 7.11 Permanent Delete
  - Delete forever button (red) on each trash item
  - Confirmation dialog with warning
  - permanentlyDeletePlace() deletes place_tags then place
  - Place removed from trash after permanent deletion
- [x] Page Integration - src/app/page.tsx
  - Edit button (pencil icon) added to panel header
  - EditPlaceModal opens when edit clicked
  - Tags fetched when place selected
  - Refresh places after edit save or delete

### Phase 6: Place Details Panel (COMPLETE)
- [x] 6.1-6.3 Responsive Panel Component - src/components/PlaceDetailsPanel.tsx
  - Single component handles both mobile and desktop views
  - Mobile: Slide-up panel from bottom with backdrop blur
  - Desktop: Side panel fixed on right (380px width)
  - CSS transitions for smooth open/close animations (300ms)
  - Responsive detection via window.innerWidth check (< 1024px = mobile)
  - Drag handle on mobile for visual affordance
  - X button to close on both variants
- [x] 6.4 Wire Up Panel - src/app/page.tsx
  - selectedPlace and isPanelOpen state management
  - handleMarkerClick finds place by ID and opens panel
  - handleClosePanel with delayed clear for animation
  - Panel receives place data and callbacks
- [x] 6.5 Display Basic Info
  - Place name in header (truncated if long)
  - Address with MapPin icon
- [x] 6.6 Display Extended Info
  - Rating with Star icon (amber filled)
  - Opening hours with Clock icon
  - Website with Globe icon (displays hostname only)
  - Phone with Phone icon (clickable tel: link)
  - Notes section with border separator
  - All fields conditionally rendered only if present
- [x] 6.7 Collection Link
  - Collection badge below title
  - Shows collection icon and name
  - Styled with collection color (20% opacity background)
  - Clickable - triggers onCollectionClick callback
  - Logs to console, will filter map in Phase 9
- [x] 6.8 Copy Address Button
  - "Copy address" button below address text
  - Uses navigator.clipboard.writeText()
  - Shows checkmark and "Copied!" feedback for 2 seconds
  - Resets when place changes
- [x] 6.9 Navigation Button
  - "Get Directions" primary action button
  - Opens Google Maps directions URL in new tab
  - Uses destination coordinates: /maps/dir/?api=1&destination=lat,lng
  - Styled with amber/orange gradient (matches app theme)
- [x] 6.10 View on Google Maps Link
  - Secondary action button below directions
  - Opens original google_maps_url if available
  - Falls back to coordinate-based URL if no original
  - Styled as secondary button (zinc background)

### Phase 5: Display Places on Map (COMPLETE)
- [x] 5.1 Fetch Places - src/app/actions/places.ts
  - Created getPlacesWithCollections() function
  - PlaceWithCollection interface extends Place with collection data
  - Uses Supabase join to fetch places with their collection (id, name, color, icon)
  - Excludes soft-deleted places (deleted_at is null)
  - Console logs show "[Places Loaded]" with count
- [x] 5.2 Basic Markers - src/components/Map.tsx
  - Map component updated to accept places prop
  - Renders MapMarker for each place with valid coordinates
  - Uses react-map-gl Marker component with anchor="bottom"
- [x] 5.3 Custom Pin Color - src/components/MapMarker.tsx
  - Created custom MapMarker component with teardrop SVG shape
  - Pin color uses collection.color (hex)
  - Drop shadow for depth (filter: drop-shadow)
  - Hover/active scale transitions for interactivity
- [x] 5.4 Pin Icons - src/components/MapMarker.tsx
  - Icon displayed in center of pin using lucide-react
  - Finds icon by name using findIconByName() from lib/icons.ts
  - Contrast color (white/black) calculated based on background luminance
  - Icon sized at 14px with 2.5 stroke width for visibility
- [x] 5.5 Zoom to Fit All - src/components/Map.tsx
  - Uses mapRef with useEffect to fit bounds when places change
  - Single place: flyTo with zoom 15
  - Multiple places: fitBounds with calculated bounds
  - No places: center on London (default)
  - Responsive padding: more on desktop (sidebar), less on mobile
  - Max zoom capped at 16 to prevent over-zooming
- [x] 5.6 Click Handler - src/components/MapMarker.tsx
  - onClick prop passed to Marker component
  - Uses MarkerEvent<MouseEvent> type for proper typing
  - Stops event propagation to prevent map click
  - Console logs "[Marker Clicked] Place ID: xxx"
  - onMarkerClick callback wired from page through Map component
- [x] Page Integration - src/app/page.tsx
  - Page converted to client component for state management
  - Fetches places on mount using getPlacesWithCollections()
  - Passes places to Map component
  - onPlaceAdded callback refreshes places when new place saved
  - Empty state only shown when loading complete and no places

### Phase 4: Add Place via Paste (COMPLETE)
- [x] 4.1 Paste Listener - src/components/Layout.tsx
  - Added global paste event listener using useEffect
  - Listens to window paste events across entire application
  - Logs pasted text to console with [Paste Detected] prefix
  - Proper cleanup on component unmount to prevent memory leaks
  - Works alongside normal paste operations in text inputs
  - Build passes successfully
- [x] 4.2 Google Maps URL Detection - src/lib/maps.ts
  - Created utility functions: isGoogleMapsUrl(), extractGoogleMapsUrl(), detectMapsUrl()
  - Supports multiple URL formats:
    - Standard google.com/maps URLs
    - maps.google.com domain
    - Regional Google domains (.co.uk, .de, .au, etc.)
    - Shortened goo.gl/maps URLs
    - New maps.app.goo.gl format
  - Automatically adds https:// protocol if missing
  - Returns MapsUrlDetectionResult with validation status and extracted URL
  - Integrated with paste listener in Layout component
  - Console logs show "[Google Maps URL Detected]" or "[Not a Google Maps URL]"
  - Created test-urls.md documenting supported formats
  - Build passes successfully
- [x] 4.3 Extract Coordinates from URL - src/lib/maps.ts
  - Created extractCoordinatesFromUrl() function with Coordinates type
  - Handles 5 different coordinate formats in Google Maps URLs:
    - /@lat,lng format (most common): /@51.5007292,-0.1268141,17z
    - !3d!4d format: !3d51.5007!4d-0.1268
    - ?q=lat,lng format: ?q=51.5074,-0.1278
    - ?ll=lat,lng format: ?ll=52.520008,13.404954
    - ?center=lat,lng format: ?center=40.7128,-74.0060
  - Validates coordinates are within valid geographic ranges (lat: -90 to 90, lng: -180 to 180)
  - Returns null if coordinates cannot be extracted or are invalid
  - isValidCoordinate() helper function for validation
  - Error handling with try/catch
  - Integrated with paste handler in Layout.tsx
  - Console logs show "[Coordinates Extracted]" with lat/lng values
  - Updated test-urls.md with coordinate extraction examples
  - Build passes successfully
- [x] 4.4 Place Data Extraction (Basic) - src/lib/geocoding.ts
  - Created reverseGeocode() function using OpenStreetMap Nominatim API (free, no API key required)
  - Created forwardGeocode() function for address-to-coordinates conversion (for Phase 12)
  - PlaceInfo interface with name, address, displayName, lat, lng, placeType, city, country
  - Extracts place name from multiple Nominatim response fields (amenity, building, shop, tourism, etc.)
  - Builds formatted address from components (house_number, road, suburb, city, postcode, country)
  - Proper User-Agent header for Nominatim API compliance
  - Rate limiting note: 1 request per second (Nominatim usage policy)
  - Error handling with try/catch for network failures
  - Integrated with paste handler in Layout.tsx (async/await)
  - Console logs show "[Fetching place info...]" and "[Place Info Retrieved]" with name/address
  - Created geocoding.test-examples.md with test cases for Big Ben, Eiffel Tower, Sydney Opera House, Colosseum
  - Build passes successfully
- [x] 4.5 Place Data Extraction (Extended) - src/lib/maps.ts, src/lib/geocoding.ts
  - **Research findings**: Free APIs (Nominatim) cannot provide rating, hours, website, phone
    - Google Places API required for this data (paid, not in scope)
    - Decision: Extended fields will be user-provided in Phase 7 (Edit Place)
  - Added extractPlaceNameFromUrl() function to extract place names from Google Maps URLs
    - Parses /place/PlaceName/ format from URLs
    - URL-decodes the name (+ → space, %20 → space, etc.)
    - More accurate than geocoding for named places
  - Extended PlaceInfo interface with optional fields:
    - rating (number, 1-5 scale)
    - openingHours (string, free-form text)
    - website (string)
    - phone (string)
    - googleMapsUrl (string, original URL for tracking)
    - urlExtractedName (string, name from URL parsing)
  - Updated paste handler in Layout.tsx to:
    - Extract place name from URL first (prioritized over geocoded name)
    - Log comprehensive "[All Extracted Place Data]" object with all fields
    - Handle partial data when geocoding fails but URL has name
  - Updated maps.test-urls.md with place name extraction test cases
  - Build passes successfully
- [x] 4.6 Add to Collection Modal (UI) - src/components/AddPlaceModal.tsx
  - Created AddPlaceModal component with:
    - Place info card showing name, address, coordinates, and "View on Maps" link
    - Warm gradient card design (amber-50 to orange-50) matching app aesthetic
    - Collection dropdown selector with:
      - Fetches collections from database on modal open
      - Shows collection color/icon badge
      - Dropdown with selection state and checkmark
      - Handles empty state (no collections yet)
      - Handles loading state
    - Save and Cancel action buttons
  - ExtractedPlace interface defined for type-safe place data
  - Integrated with Layout.tsx:
    - Added isAddPlaceOpen, extractedPlace, isAddingPlace state
    - Paste handler now opens modal with extracted place data
    - handleSavePlace and handleCloseAddPlace handlers (save logic TODO in Phase 4.7)
  - Build passes successfully
- [x] 4.7 Save Place to Database - src/app/actions/places.ts
  - Created createPlace() server action to insert into places table
  - Created getPlaces() to fetch all non-deleted places
  - Created getPlacesByCollection() to fetch places for a collection
  - Place interface matches database schema (id, collection_id, name, address, lat, lng, etc.)
  - Uses getOrCreateDefaultCollection() if no collection specified
  - Integrated with Layout.tsx handleSavePlace handler
  - Console logs show "[Place Saved Successfully]" on save
  - Build passes successfully
- [x] 4.8 Success Feedback - src/components/Toast.tsx
  - Created Toast component with success/error variants
  - ToastContainer for managing multiple toasts
  - Auto-dismiss after 4 seconds with manual dismiss option
  - Animated entrance/exit transitions
  - Success toast: green with checkmark icon
  - Error toast: red with X icon
  - Integrated with Layout.tsx via showToast() and dismissToast()
  - Shows "Place added to your collection!" on successful save
  - Build passes successfully
- [x] 4.9 Error Handling - src/components/Layout.tsx
  - Added error toasts for various failure scenarios:
    - Geocoding failure with partial data: allows saving with warning
    - Geocoding failure without name: shows error, suggests manual entry
    - No coordinates in URL: suggests trying different link
  - Non-Maps URLs are silently ignored (no spam on normal paste)
  - Save failures show error toast with message
  - Build passes successfully

### Phase 3: Collections (COMPLETE)
- [x] 3.1 Color Palette - src/lib/colors.ts and src/components/ColorPicker.tsx
  - 16 curated colors: warm (red, orange, amber, yellow), cool (lime, green, teal, cyan), blues/purples (blue, indigo, violet, purple), pinks/neutrals (pink, rose, stone, slate)
  - ColorPicker component: 8-column grid, selection state with checkmark, hover/focus animations
  - Helper functions: findColorByValue(), getContrastColor()
  - Default color: Amber (matches app accent)
- [x] 3.2 Icon Set Curation - src/lib/icons.ts
  - lucide-react already installed from Phase 2.1
  - 76 curated place-related icons organized by category
  - Categories: General, Food & Drink, Shopping, Entertainment, Recreation, Travel, Health, Education, Home, Nature, Services
  - Helper functions: findIconByName(), getIconCategories(), getIconsByCategory()
  - Default icon: MapPin
- [x] 3.3 Icon Picker Component - src/components/IconPicker.tsx
  - Scrollable grid (max-h-64) with 8-column layout
  - Search functionality to filter icons by name/category
  - Category filter pills for quick filtering
  - Selection state with checkmark badge
  - Supports custom accent color via prop
  - Icons grouped by category with headers
- [x] 3.4 Create Collection UI - src/components/Modal.tsx, src/components/NewCollectionModal.tsx
  - Reusable Modal component with backdrop, close-on-escape, accessibility
  - NewCollectionModal with name input, ColorPicker, IconPicker
  - Live preview of collection (color + icon + name)
  - Form validation (name required)
  - Submit/Cancel buttons with loading state
- [x] 3.5 Create Collection Save - src/app/actions/collections.ts
  - Server action createCollection() inserts into Supabase collections table
  - Added "New Collection" button to Layout header
  - Modal closes on successful creation
  - onCollectionCreated callback for parent refresh
- [x] 3.6 Fetch Collections - src/app/actions/collections.ts
  - Server action getCollections() fetches all collections
  - Orders by created_at descending (newest first)
- [x] 3.7 Display Collections - src/components/CollectionsList.tsx
  - Desktop: Always-visible sidebar (320px) with collections list
  - Mobile: Collections button opens slide-up panel
  - Shows name, color swatch with icon for each collection
  - Selection state highlighting
  - Empty state with "Create your first collection" prompt
  - Auto-refreshes when new collection is created
- [x] 3.8 Default Collection - src/app/actions/collections.ts
  - Added getOrCreateDefaultCollection() function
  - Default collection: "My Places" with Amber color and MapPin icon
  - Returns existing collection if any exist, creates default otherwise
  - Ready for use in Phase 4 when adding places

### Phase 0: Project Setup (COMPLETE)
- [x] 0.1 Initialize Next.js with App Router (commit: 1b205b7)
- [x] 0.2 Tailwind CSS configured and tested
- [x] 0.3 Environment & Git setup (.env.local.example created)
- [x] 0.4 Project structure created (components/, lib/, app/)
- [x] 0.5 Supabase client setup (lib/supabase.ts) (commit: 05922ea)
- [x] 0.6-0.9 Database schema created:
  - settings table (key, value)
  - collections table (id, name, color, icon, timestamps)
  - places table (all fields per schema)
  - tags table (id, name)
  - place_tags junction table (place_id, tag_id)

### Phase 1: Map Foundation (COMPLETE)
- [x] 1.1 Mapbox Setup - installed mapbox-gl@3.18.0 and react-map-gl@8.1.0
- [x] 1.2 Basic Map component - components/Map.tsx, centered on London (51.5074, -0.1278)
- [x] 1.3 Map styling - using mapbox://styles/mapbox/light-v11, fills viewport
- [x] 1.4 Responsive layout shell - components/Layout.tsx with flex layout
- [x] 1.5 Empty state overlay - components/EmptyState.tsx with prompt message

### Phase 2: Password Protection (COMPLETE)
- [x] 2.1 Password Setup Screen - src/app/setup/page.tsx
  - Form with password and confirm password inputs
  - Show/hide password toggle using lucide-react icons
  - Validation: minimum 8 characters, passwords must match
  - Glass-morphism design with amber accent color
  - Installed lucide-react package
- [x] 2.2 Password Hashing - src/lib/auth.ts
  - Using Web Crypto API with PBKDF2 (no external dependencies)
  - 100,000 iterations, SHA-256 hash, 256-bit key
  - Random 16-byte salt per password
  - Hash format: salt:hash (hex encoded)
  - Constant-time comparison to prevent timing attacks
  - Functions: hashPassword(), verifyPassword()
- [x] 2.3 Store Password Hash - src/app/setup/actions.ts
  - Server action setupPassword() hashes and saves to settings table
  - Server action isPasswordSet() checks if password exists
  - Setup form connected to server action with error handling
  - Redirects to main page on success
- [x] 2.4 Password Entry Screen - src/app/login/page.tsx
  - Login form with password input and submit button
  - Show/hide password toggle
  - Error display for failed login attempts
  - Matches setup page design aesthetic
- [x] 2.5 Password Verification - src/app/login/actions.ts
  - Server action verifyPasswordAction() fetches hash from settings table
  - Uses verifyPassword() from lib/auth.ts for constant-time comparison
  - Returns success/error object to client
  - Login form wired to server action with error handling
  - Incorrect password shows user-friendly error message
  - Correct password redirects to main page (session token to be added in 2.6)
- [x] 2.6 Session Token - src/lib/auth.ts
  - Added generateSessionToken() using crypto.getRandomValues (32 bytes, 256 bits)
  - Converts to URL-safe base64 format
  - Added setSessionToken(), getSessionToken(), clearSessionToken() for localStorage
  - Added isAuthenticated() helper to check if session exists
  - Login page now generates and stores token on successful authentication
  - Token is cryptographically secure and collision-resistant
- [x] 2.7 Auth State Check - src/lib/auth.ts
  - Already implemented in Phase 2.6 with isAuthenticated() function
  - Checks if session token exists in localStorage
  - Returns boolean for quick auth status checks
- [x] 2.8 Route Protection - src/components/AuthGuard.tsx
  - Created AuthGuard component to protect routes
  - Checks if password is set via isPasswordSet() server action
  - Redirects to /setup if no password exists
  - Checks authentication status via isAuthenticated()
  - Redirects to /login if not authenticated
  - Shows loading spinner during auth check
  - Wrapped root layout with AuthGuard for app-wide protection
  - Public routes (/setup, /login) bypass auth check
- [x] 2.9 Logout - src/components/Layout.tsx
  - Added logout button in top-right corner with glass-morphism style
  - Button uses LogOut icon from lucide-react
  - Clicking logout clears session token via clearSessionToken()
  - Redirects to login page after logout
  - Styled to match existing UI aesthetic with backdrop blur and shadows

---

## Decisions Made

### Database
- Using Supabase (PostgreSQL) with free tier
- All tables created via Supabase dashboard/SQL editor
- Foreign key from places.collection_id → collections.id
- Soft delete via deleted_at timestamp on places

### Project Structure
- /src/app - Next.js App Router pages
- /src/components - React components
- /src/lib - Utility functions (supabase.ts, etc.)
- /docs - Documentation (roadmap.md, PRD.md, progress.txt)

### Map Implementation
- Using react-map-gl v8 with subpath import: `react-map-gl/mapbox`
- Map style: mapbox://styles/mapbox/light-v11 (clean, minimal)
- Initial zoom level: 11

### UI/Design
- Minimal, clean aesthetic
- Empty state overlay positioned at bottom center
- Glass-morphism style card (bg-white/95 with backdrop-blur)
- Responsive breakpoint at lg (1024px) for desktop side panel

---

## Blockers Encountered

### 2026-01-21 - react-map-gl import issue with Turbopack
**Problem**: Build failed with "Module not found: Can't resolve 'react-map-gl'"
**Why it failed**: react-map-gl v8 uses subpath exports, no default export
**Solution**: Changed import from `react-map-gl` to `react-map-gl/mapbox`

---

## Failed Approaches

### 2026-01-21 - Default react-map-gl import
**Problem**: `import MapGL from 'react-map-gl'` failed in Turbopack
**Why it failed**: react-map-gl v8 restructured exports to use subpaths
**Better approach**: Use `import { Map } from 'react-map-gl/mapbox'` for Mapbox GL

---

## Files Changed Log

### 2026-01-21
- Created: docs/progress.txt
- Modified: CLAUDE.md (added progress tracking instructions)
- Modified: package.json (added mapbox-gl, react-map-gl)
- Created: src/components/Map.tsx
- Created: src/components/Layout.tsx
- Created: src/components/EmptyState.tsx
- Modified: src/app/page.tsx (uses Layout, Map, EmptyState)
- Modified: src/app/layout.tsx (updated title and description)

### 2026-01-21 (Phase 2.1)
- Created: src/app/setup/page.tsx (password setup form)
- Modified: package.json (added lucide-react)

### 2026-01-21 (Phase 2.2)
- Created: src/lib/auth.ts (password hashing utilities)

### 2026-01-21 (Phase 2.3)
- Created: src/app/setup/actions.ts (server actions for password setup)
- Modified: src/app/setup/page.tsx (connected to server action)

### 2026-01-21 (Phase 2.4)
- Created: src/app/login/page.tsx (login form)

### 2026-01-21 (Phase 2.5)
- Created: src/app/login/actions.ts (password verification server action)
- Modified: src/app/login/page.tsx (connected to verifyPasswordAction)

### 2026-01-21 (Phase 2.6)
- Modified: src/lib/auth.ts (added session token functions)
- Modified: src/app/login/page.tsx (generate and store token on login)

### 2026-01-21 (Phase 2.7)
- Already completed in Phase 2.6 (isAuthenticated function)

### 2026-01-21 (Phase 2.8)
- Created: src/components/AuthGuard.tsx (route protection component)
- Modified: src/app/layout.tsx (wrapped with AuthGuard)

### 2026-01-21 (Phase 2.9)
- Modified: src/components/Layout.tsx (added logout button and handler)

### 2026-01-21 (Phase 3.1)
- Created: src/lib/colors.ts (16 preset colors for collection pins)
- Created: src/components/ColorPicker.tsx (color swatch grid with selection)

### 2026-01-21 (Phase 3.2)
- Created: src/lib/icons.ts (76 curated place-related icons)

### 2026-01-21 (Phase 3.3)
- Created: src/components/IconPicker.tsx (scrollable icon grid with search and filtering)

### 2026-01-21 (Phase 3.4)
- Created: src/components/Modal.tsx (reusable modal/dialog component)
- Created: src/components/NewCollectionModal.tsx (collection creation form)

### 2026-01-21 (Phase 3.5 & 3.6)
- Created: src/app/actions/collections.ts (server actions for collections CRUD)
- Modified: src/components/Layout.tsx (added New Collection button and modal integration)

### 2026-01-21 (Phase 3.7)
- Created: src/components/CollectionsList.tsx (collections sidebar with mobile panel)
- Modified: src/components/Layout.tsx (integrated CollectionsList with desktop sidebar and mobile slide-up)

### 2026-01-21 (Phase 3.8)
- Modified: src/app/actions/collections.ts (added getOrCreateDefaultCollection function)

### 2026-01-21 (Phase 4.1)
- Modified: src/components/Layout.tsx (added global paste event listener)

### 2026-01-21 (Phase 4.2)
- Created: src/lib/maps.ts (Google Maps URL detection utilities)
- Created: src/lib/maps.test-urls.md (test cases documentation)
- Modified: src/components/Layout.tsx (integrated Maps URL detection with paste listener)

### 2026-01-21 (Phase 4.3)
- Modified: src/lib/maps.ts (added coordinate extraction functions)
- Modified: src/lib/maps.test-urls.md (added coordinate extraction test cases)
- Modified: src/components/Layout.tsx (integrated coordinate extraction with paste handler)

### 2026-01-21 (Phase 4.4)
- Created: src/lib/geocoding.ts (reverse and forward geocoding with Nominatim API)
- Created: src/lib/geocoding.test-examples.md (test cases documentation)
- Modified: src/components/Layout.tsx (integrated reverse geocoding with paste handler)

### 2026-01-21 (Phase 4.5)
- Modified: src/lib/maps.ts (added extractPlaceNameFromUrl function)
- Modified: src/lib/geocoding.ts (extended PlaceInfo interface with optional fields)
- Modified: src/components/Layout.tsx (integrated place name extraction, comprehensive logging)
- Modified: src/lib/maps.test-urls.md (added place name extraction test cases)

### 2026-01-21 (Phase 4.6)
- Created: src/components/AddPlaceModal.tsx (modal for adding places from paste)
- Modified: src/components/Layout.tsx (integrated AddPlaceModal with paste handler)

### 2026-01-21 (Phase 4.7)
- Created: src/app/actions/places.ts (server actions for places CRUD)
- Modified: src/components/Layout.tsx (integrated createPlace with save handler)

### 2026-01-21 (Phase 4.8)
- Created: src/components/Toast.tsx (toast notification system)
- Modified: src/components/Layout.tsx (integrated toast notifications)

### 2026-01-21 (Phase 4.9)
- Modified: src/components/Layout.tsx (added error handling with toast feedback)

### 2026-01-21 (Phase 5.1-5.6)
- Modified: src/app/actions/places.ts (added getPlacesWithCollections, PlaceWithCollection interface)
- Created: src/components/MapMarker.tsx (custom colored pin with icon)
- Modified: src/components/Map.tsx (accepts places, renders markers, fits bounds, handles clicks)
- Modified: src/app/page.tsx (client component, fetches places, passes to Map)
- Modified: src/components/Layout.tsx (added onPlaceAdded callback prop)

### 2026-01-21 (Phase 6.1-6.10)
- Created: src/components/PlaceDetailsPanel.tsx (responsive place details panel)
- Modified: src/app/page.tsx (added panel state, marker click opens panel)

### 2026-01-21 (Phase 7.1-7.11)
- Modified: src/app/actions/places.ts (added updatePlace, softDeletePlace, restorePlace, permanentlyDeletePlace, tag functions)
- Created: src/components/TagInput.tsx (tag input with chips)
- Created: src/components/EditPlaceModal.tsx (edit place modal with tags and collection dropdown)
- Modified: src/components/PlaceDetailsPanel.tsx (added edit button, tags display, Tag type import)
- Modified: src/app/page.tsx (integrated EditPlaceModal, tags fetching)
- Created: src/app/trash/page.tsx (trash view with restore/delete)
- Modified: src/components/Layout.tsx (added Trash button)

### 2026-01-22 (Phase 8.1-8.6)
- Created: src/components/EditCollectionModal.tsx (edit/delete collection modal)
- Modified: src/app/actions/collections.ts (added updateCollection, deleteCollection, getCollectionPlaceCounts)
- Modified: src/components/CollectionsList.tsx (added edit/focus buttons, place counts)
- Modified: src/components/Layout.tsx (integrated EditCollectionModal, onFocusCollection)
- Modified: src/components/Map.tsx (added focusCollectionId, focusTrigger props)
- Modified: src/app/page.tsx (added handleFocusCollection, focusCollectionId state)

### 2026-01-22 (Phase 9.1-9.9 & Phase 10.1-10.6)
- Created: src/components/FilterBar.tsx (collection/tag filter dropdowns, search bar, clear button)
- Created: src/components/ViewToggle.tsx (map/list view toggle button)
- Created: src/components/ListView.tsx (list view with grouping, sorting, item selection)
- Modified: src/app/page.tsx (integrated filters, search, view toggle, list view)
  - Added filter state (selectedCollections, selectedTags, searchQuery)
  - Added placeTagsMap for efficient tag filtering
  - Added filteredPlaces memoized computation
  - Added viewMode state for map/list toggle
  - Connected collection/tag clicks in panel to filter actions
  - Parallel data fetching for places, collections, and tags

### 2026-01-22 (Phase 11.1-11.3)
- Created: src/components/ContextMenu.tsx (context menu component)
- Modified: src/components/MapMarker.tsx (added onContextMenu, touch handlers for long press)
- Modified: src/components/Map.tsx (added onMarkerContextMenu prop)
- Modified: src/app/page.tsx (added context menu state and handlers)

### 2026-01-22 (Phase 12.1-12.4)
- Created: src/components/ManualPlaceModal.tsx (manual place entry form)
- Modified: src/components/Layout.tsx (added manual place button and modal integration)

### 2026-01-22 (Phase 13.1-13.3)
- Modified: src/app/actions/places.ts (added duplicate detection functions)
  - calculateDistance() for Haversine formula
  - checkDuplicateByCoordinates() for ~50m proximity check
  - checkDuplicateByUrl() for exact URL match
  - checkForDuplicates() combines both checks
- Created: src/components/DuplicateWarningModal.tsx (duplicate warning UI)
- Modified: src/components/Layout.tsx (integrated duplicate detection)

---

## Learnings

### Web Crypto API for Password Hashing
- PBKDF2 is available natively in browsers and Node.js via Web Crypto API
- No need for external packages like bcrypt
- Use salt.buffer as ArrayBuffer when passing to crypto.subtle.deriveBits()
- TypeScript strict mode requires explicit type casting for ArrayBuffer

### react-map-gl v8 Breaking Changes
- v8 uses ES module subpath exports
- Import from `react-map-gl/mapbox` for Mapbox GL JS
- Import from `react-map-gl/maplibre` for MapLibre GL JS
- The Map component is named export, not default: `{ Map }`

### Next.js 16 with Turbopack
- Turbopack has stricter module resolution than Webpack
- Some npm packages may need specific import paths
- Build errors often more informative than dev server errors

---

### 2026-01-22 (Phase 14.1-14.7)
- Created: public/manifest.json (PWA manifest with share target)
- Created: public/sw.js (service worker)
- Created: public/icons/icon.svg (source icon)
- Created: public/icons/icon-192.png, icon-512.png (generated icons)
- Created: public/icons/icon-maskable-192.png, icon-maskable-512.png (maskable icons)
- Created: public/icons/apple-touch-icon.png, favicon-16.png, favicon-32.png
- Created: scripts/generate-icons.mjs (icon generation script)
- Created: scripts/generate-icons.html (alternative browser-based generator)
- Created: src/components/ServiceWorkerRegistration.tsx (SW registration)
- Created: src/components/InstallPrompt.tsx (PWA install banner)
- Created: src/app/share/page.tsx (share target handler)
- Modified: src/app/layout.tsx (manifest link, viewport, SW registration)
- Modified: src/app/page.tsx (shared place handling, Suspense wrapper)
- Modified: src/components/Layout.tsx (paste button, shared place props)

---

## Next Steps (from roadmap.md)

1. Phase 15: Polish & Edge Cases
2. Phase 16: Deployment

Note: Export & Import moved to future features.

Reference: docs/roadmap.md for full task breakdown
