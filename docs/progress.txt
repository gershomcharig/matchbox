# Matchbook Development Progress

This file tracks accomplishments, failures, and learnings across execution loops.
Read this file at the start of each session to maintain context and avoid repeating mistakes.

---

## Current Status
**Last Updated**: 2026-01-27
**Current Phase**: API Data Pipeline Enhancement COMPLETE
**Next Step**: Phase 16 - Production Testing (add DB columns first)

---

## Completed Tasks

### Phase 15: Polish & Edge Cases (COMPLETE)
- [x] 15.1 Loading States
  - Added refreshing indicator (floating pill) when data is being updated
  - Shows "Updating..." with spinner during edit/delete/move operations
  - isRefreshing state tracks async refresh operations
- [x] 15.2 Error Messages
  - Extended Toast component to support 'info' type (blue styling)
  - Error toasts already exist for various failure scenarios
  - Clipboard errors now have better messaging
- [x] 15.3 Empty States
  - ListView: Differentiated empty states for "no results from filter" vs "no places at all"
    - Filter empty: "No matching places" with suggestion to adjust filters
    - No data: "No places yet" with prompt to paste or add manually
  - PlaceDetailsPanel: Added "No tags" placeholder when place has no tags
  - Existing empty states reviewed: collections list, trash page, main map already have good empty states
- [x] 15.4 Soft Limits Warning
  - Added SOFT_LIMIT_THRESHOLD constant (500 places)
  - Banner appears when data exceeds threshold
  - Dismissible with "X" button
  - Includes helpful message about performance and archiving
- [x] 15.5 Responsive Review
  - Soft limit warning positioned correctly for both mobile and desktop
  - All existing responsive layouts verified (sidebar, panels, filters)
- [x] 15.6 Accessibility
  - FilterBar: Added role="search", aria-label, aria-expanded, aria-haspopup
  - Search input: Changed type to "search" with proper aria-label
  - Collection/Tag dropdowns: Added aria-expanded and aria-haspopup="listbox"
  - Clear buttons: Added aria-label attributes
  - Escape key closes filter dropdowns
  - MapMarker: Added role="button", tabIndex={0}, aria-label with place name
  - MapMarker: Added keyboard support (Enter/Space to activate)

### Phase 14: PWA & Share Sheet (COMPLETE)
- [x] 14.1 Manifest File - public/manifest.json
  - App name, description, theme colors
  - Icons in multiple sizes (192, 512, maskable variants)
  - Apple web app configuration
  - Shortcuts for quick actions
  - Linked in layout.tsx via Next.js Metadata
- [x] 14.2 App Icons - public/icons/
  - Generated via scripts/generate-icons.mjs using sharp
  - icon-192.png, icon-512.png (standard)
  - icon-maskable-192.png, icon-maskable-512.png (safe zone)
  - apple-touch-icon.png (180x180)
  - favicon-16.png, favicon-32.png
  - icon.svg (source file)
- [x] 14.3 Service Worker - public/sw.js
  - Cache-first strategy for static assets
  - Network-first with cache fallback for dynamic content
  - ServiceWorkerRegistration component registers on load
  - Handles update detection
- [x] 14.4 Install Prompt - src/components/InstallPrompt.tsx
  - Listens for beforeinstallprompt event
  - Shows install banner with app benefits
  - Dismissible with 7-day cooldown (stored in localStorage)
  - Hidden when already installed as PWA
- [x] 14.5 Share Target Config - public/manifest.json
  - share_target with action: "/share"
  - Receives title, text, url parameters
  - GET method for simple URL sharing
- [x] 14.6 Share Target Handler - src/app/share/page.tsx
  - Parses shared content from URL params
  - Detects Google Maps URLs in shared text
  - Extracts coordinates and place name
  - Stores place data in sessionStorage
  - Redirects to main app with fromShare=true
  - Main page.tsx picks up shared place and opens AddPlaceModal
  - Error handling for non-Maps links
- [x] 14.7 Paste Button (Mobile) - src/components/Layout.tsx
  - Floating "Paste Link" button at bottom center on mobile
  - Uses navigator.clipboard.readText() API
  - Processes pasted text same as global paste handler
  - Error messages for empty clipboard or non-Maps URLs
  - Gradient styling matching app theme

### Phase 13: Duplicate Detection (COMPLETE)
- [x] 13.1 Check by Coordinates - src/app/actions/places.ts
  - checkDuplicateByCoordinates() function using Haversine formula
  - calculateDistance() helper to compute distance in meters
  - Default threshold of 50 meters
  - Returns existing place if duplicate found
- [x] 13.2 Check by URL - src/app/actions/places.ts
  - checkDuplicateByUrl() function for exact URL matching
  - checkForDuplicates() combines both checks (URL first, then coordinates)
- [x] 13.3 Warning UI - src/components/DuplicateWarningModal.tsx
  - Shows warning with existing place info (name, address, collection)
  - Explains match type (coordinates vs URL)
  - "Add Anyway" and "Cancel" options
  - Integrated into both paste and manual entry flows in Layout.tsx
  - Pending place data stored while waiting for user decision

### Phase 12: Manual Place Entry (COMPLETE)
- [x] 12.1 Add Manually Button - src/components/Layout.tsx
  - MapPinPlus icon button in top bar
  - "Add Place" label on desktop, icon-only on mobile
  - Opens ManualPlaceModal
- [x] 12.2 Manual Entry Form - src/components/ManualPlaceModal.tsx
  - Name field (required) with validation
  - Address field (required) with validation and geocoding hint
  - Notes field (optional) with textarea
  - Tags field (optional) using TagInput component
  - Collection dropdown selector (same as AddPlaceModal)
  - Form validation with touched state tracking
  - Error display for geocoding failures
- [x] 12.3 Geocode Address - src/lib/geocoding.ts
  - forwardGeocode() already implemented in Phase 4
  - Uses OpenStreetMap Nominatim API
  - Returns PlaceInfo with lat, lng, and formatted address
- [x] 12.4 Save Manual Place
  - Creates place with geocoded coordinates
  - Saves notes and tags
  - Shows success toast on completion
  - Refreshes map markers

### Phase 11: Context Menu (COMPLETE)
- [x] 11.1 Desktop Right-Click Menu - src/components/MapMarker.tsx
  - onContextMenu handler on marker div
  - Prevents default browser context menu
  - Passes placeId and cursor position to callback
- [x] 11.2 Mobile Long-Press Menu - src/components/MapMarker.tsx
  - onTouchStart starts 500ms timer
  - onTouchMove cancels if moved > 10px
  - onTouchEnd/onTouchCancel clears timer
  - longPressTriggered ref prevents click after long press
- [x] 11.3 Context Menu Actions - src/components/ContextMenu.tsx
  - Edit: Opens EditPlaceModal with place data
  - Move to: Submenu with all collections (except current)
    - Updates place collection_id on selection
  - Copy address: Copies to clipboard with "Copied!" feedback
  - Get directions: Opens Google Maps directions in new tab
  - Delete: Soft deletes place immediately
  - Context menu positioned with viewport boundary detection
  - Click-outside and Escape key to close
  - Animated entrance with fade-in zoom

### Phase 10: List View (COMPLETE)
- [x] 10.1 View Toggle - src/components/ViewToggle.tsx
  - Map/List toggle button component
  - Styled with amber highlight for active view
  - Icons for Map and List views
  - Positioned bottom-left on mobile, near filter bar on desktop
- [x] 10.2 List View Component - src/components/ListView.tsx
  - Full list view layout with grouping by collection
  - Collection headers with color accent border
  - Empty state when no places to show
- [x] 10.3 List Item Styling
  - Place name, address, and date added
  - Collection color indicator dot
  - Hover and selection states
  - Responsive layout with truncation
- [x] 10.4 Sort by Date
  - Sort dropdown with "Newest first" and "Oldest first" options
  - Uses created_at timestamp for sorting
- [x] 10.5 Sort Alphabetically
  - "A to Z" and "Z to A" sort options
  - Uses localeCompare for proper string sorting
- [x] 10.6 Click to Open Details
  - Clicking list item opens place details panel
  - Selected place highlighted in list
  - Same panel used as map view

### Phase 9: Filtering & Search (COMPLETE)
- [x] 9.1-9.2 Collection Filter - src/components/FilterBar.tsx
  - Collection dropdown with multi-select
  - Shows collection color/icon swatches
  - Filter badge shows active filter count
  - Updates map markers to show only selected collections
- [x] 9.3-9.4 Tag Filter
  - Tag dropdown with multi-select
  - AND logic - place must have ALL selected tags
  - Populates with all tags in the system
  - Filter badge shows active filter count
- [x] 9.5 Clear Filters
  - "Clear" button appears when any filter is active
  - Resets collections, tags, and search query
- [x] 9.6 Clickable Collection
  - Clicking collection in place panel sets collection filter
  - Closes panel and filters map to that collection
- [x] 9.7 Clickable Tags
  - Clicking tag in place panel adds tag to filter
  - Accumulates with existing tag filters (AND logic)
- [x] 9.8-9.9 Search Bar
  - Search input in filter bar
  - Searches place names, addresses, notes, tags, and collection names
  - Clear button to reset search
  - Real-time filtering as you type

### Phase 8: Collections Management (COMPLETE)
- [x] 8.1 Edit Collection UI - src/components/EditCollectionModal.tsx
  - Edit button (pencil icon) on each collection in CollectionsList
  - Modal opens with pre-filled name, color, and icon values
  - Live preview of collection appearance
  - Uses existing ColorPicker and IconPicker components
- [x] 8.2 Save Collection Edits - src/app/actions/collections.ts
  - updateCollection() server action updates name, color, icon
  - UI refreshes collections list and map pins after save
  - Success toast notification
- [x] 8.3-8.4 Delete Collection with Confirmation
  - "Delete this collection" link in edit modal
  - Confirmation dialog shows place count and explains behavior
  - Places moved to default (oldest) collection on delete
  - Cannot delete the only remaining collection
  - deleteCollection() handles moving places before deletion
- [x] 8.5 Focus on Collection - src/components/Map.tsx
  - Focus button (target icon) on each collection with places
  - Clicking zooms map to fit all places in that collection
  - Uses fitBoundsToPlaces() helper with focusCollectionId prop
  - Works on both mobile and desktop
- [x] 8.6 Place Count - src/components/CollectionsList.tsx
  - Shows "X places" below each collection name
  - getCollectionPlaceCounts() server action counts non-deleted places
  - Fetched in parallel with collections for performance

### Phase 7: Edit & Delete Places (COMPLETE)
- [x] 7.1-7.2 Edit Place Modal - src/components/EditPlaceModal.tsx
  - Modal with pre-filled name and notes inputs
  - updatePlace() server action in places.ts
  - Saves changes to database, closes modal, refreshes data
  - Error handling with error message display
- [x] 7.3-7.4 Tag Input Component - src/components/TagInput.tsx
  - Type to add tags, press Enter or comma to confirm
  - Tags displayed as chips with X button to remove
  - Backspace removes last tag when input is empty
  - Maximum 10 tags enforced
  - Server actions: getTags(), getTagsForPlace(), getOrCreateTag(), updatePlaceTags()
  - Tags stored in tags table, relationships in place_tags junction table
- [x] 7.5 Display Tags in Panel - src/components/PlaceDetailsPanel.tsx
  - Tags section with Tag icon
  - Styled as amber chips (matches color scheme)
  - Clickable - logs to console, will filter in Phase 9
  - Fetched separately via getTagsForPlace() when place selected
- [x] 7.6 Change Collection - src/components/EditPlaceModal.tsx
  - Collection dropdown with color/icon preview
  - Fetches collections on modal open
  - Updates collection_id in database on save
- [x] 7.7-7.8 Delete with Soft Delete
  - "Delete this place" link in edit modal
  - Confirmation UI appears on click
  - softDeletePlace() sets deleted_at timestamp
  - Deleted places excluded from normal queries (already implemented)
  - Panel closes after deletion
- [x] 7.9 Trash View - src/app/trash/page.tsx
  - Lists all soft-deleted places with collection info
  - Shows days remaining until permanent deletion (30 days)
  - getDeletedPlaces() server action fetches deleted_at IS NOT NULL
  - Empty state when trash is empty
  - Trash button added to Layout header
- [x] 7.10 Restore from Trash
  - Restore button (green) on each trash item
  - restorePlace() clears deleted_at timestamp
  - Place reappears on map after restore
- [x] 7.11 Permanent Delete
  - Delete forever button (red) on each trash item
  - Confirmation dialog with warning
  - permanentlyDeletePlace() deletes place_tags then place
  - Place removed from trash after permanent deletion
- [x] Page Integration - src/app/page.tsx
  - Edit button (pencil icon) added to panel header
  - EditPlaceModal opens when edit clicked
  - Tags fetched when place selected
  - Refresh places after edit save or delete

### Phase 6: Place Details Panel (COMPLETE)
- [x] 6.1-6.3 Responsive Panel Component - src/components/PlaceDetailsPanel.tsx
  - Single component handles both mobile and desktop views
  - Mobile: Slide-up panel from bottom with backdrop blur
  - Desktop: Side panel fixed on right (380px width)
  - CSS transitions for smooth open/close animations (300ms)
  - Responsive detection via window.innerWidth check (< 1024px = mobile)
  - Drag handle on mobile for visual affordance
  - X button to close on both variants
- [x] 6.4 Wire Up Panel - src/app/page.tsx
  - selectedPlace and isPanelOpen state management
  - handleMarkerClick finds place by ID and opens panel
  - handleClosePanel with delayed clear for animation
  - Panel receives place data and callbacks
- [x] 6.5 Display Basic Info
  - Place name in header (truncated if long)
  - Address with MapPin icon
- [x] 6.6 Display Extended Info
  - Rating with Star icon (amber filled)
  - Opening hours with Clock icon
  - Website with Globe icon (displays hostname only)
  - Phone with Phone icon (clickable tel: link)
  - Notes section with border separator
  - All fields conditionally rendered only if present
- [x] 6.7 Collection Link
  - Collection badge below title
  - Shows collection icon and name
  - Styled with collection color (20% opacity background)
  - Clickable - triggers onCollectionClick callback
  - Logs to console, will filter map in Phase 9
- [x] 6.8 Copy Address Button
  - "Copy address" button below address text
  - Uses navigator.clipboard.writeText()
  - Shows checkmark and "Copied!" feedback for 2 seconds
  - Resets when place changes
- [x] 6.9 Navigation Button
  - "Get Directions" primary action button
  - Opens Google Maps directions URL in new tab
  - Uses destination coordinates: /maps/dir/?api=1&destination=lat,lng
  - Styled with amber/orange gradient (matches app theme)
- [x] 6.10 View on Google Maps Link
  - Secondary action button below directions
  - Opens original google_maps_url if available
  - Falls back to coordinate-based URL if no original
  - Styled as secondary button (zinc background)

### Phase 5: Display Places on Map (COMPLETE)
- [x] 5.1 Fetch Places - src/app/actions/places.ts
  - Created getPlacesWithCollections() function
  - PlaceWithCollection interface extends Place with collection data
  - Uses Supabase join to fetch places with their collection (id, name, color, icon)
  - Excludes soft-deleted places (deleted_at is null)
  - Console logs show "[Places Loaded]" with count
- [x] 5.2 Basic Markers - src/components/Map.tsx
  - Map component updated to accept places prop
  - Renders MapMarker for each place with valid coordinates
  - Uses react-map-gl Marker component with anchor="bottom"
- [x] 5.3 Custom Pin Color - src/components/MapMarker.tsx
  - Created custom MapMarker component with teardrop SVG shape
  - Pin color uses collection.color (hex)
  - Drop shadow for depth (filter: drop-shadow)
  - Hover/active scale transitions for interactivity
- [x] 5.4 Pin Icons - src/components/MapMarker.tsx
  - Icon displayed in center of pin using lucide-react
  - Finds icon by name using findIconByName() from lib/icons.ts
  - Contrast color (white/black) calculated based on background luminance
  - Icon sized at 14px with 2.5 stroke width for visibility
- [x] 5.5 Zoom to Fit All - src/components/Map.tsx
  - Uses mapRef with useEffect to fit bounds when places change
  - Single place: flyTo with zoom 15
  - Multiple places: fitBounds with calculated bounds
  - No places: center on London (default)
  - Responsive padding: more on desktop (sidebar), less on mobile
  - Max zoom capped at 16 to prevent over-zooming
- [x] 5.6 Click Handler - src/components/MapMarker.tsx
  - onClick prop passed to Marker component
  - Uses MarkerEvent<MouseEvent> type for proper typing
  - Stops event propagation to prevent map click
  - Console logs "[Marker Clicked] Place ID: xxx"
  - onMarkerClick callback wired from page through Map component
- [x] Page Integration - src/app/page.tsx
  - Page converted to client component for state management
  - Fetches places on mount using getPlacesWithCollections()
  - Passes places to Map component
  - onPlaceAdded callback refreshes places when new place saved
  - Empty state only shown when loading complete and no places

### Phase 4: Add Place via Paste (COMPLETE)
- [x] 4.1 Paste Listener - src/components/Layout.tsx
  - Added global paste event listener using useEffect
  - Listens to window paste events across entire application
  - Logs pasted text to console with [Paste Detected] prefix
  - Proper cleanup on component unmount to prevent memory leaks
  - Works alongside normal paste operations in text inputs
  - Build passes successfully
- [x] 4.2 Google Maps URL Detection - src/lib/maps.ts
  - Created utility functions: isGoogleMapsUrl(), extractGoogleMapsUrl(), detectMapsUrl()
  - Supports multiple URL formats:
    - Standard google.com/maps URLs
    - maps.google.com domain
    - Regional Google domains (.co.uk, .de, .au, etc.)
    - Shortened goo.gl/maps URLs
    - New maps.app.goo.gl format
  - Automatically adds https:// protocol if missing
  - Returns MapsUrlDetectionResult with validation status and extracted URL
  - Integrated with paste listener in Layout component
  - Console logs show "[Google Maps URL Detected]" or "[Not a Google Maps URL]"
  - Created test-urls.md documenting supported formats
  - Build passes successfully
- [x] 4.3 Extract Coordinates from URL - src/lib/maps.ts
  - Created extractCoordinatesFromUrl() function with Coordinates type
  - Handles 5 different coordinate formats in Google Maps URLs:
    - /@lat,lng format (most common): /@51.5007292,-0.1268141,17z
    - !3d!4d format: !3d51.5007!4d-0.1268
    - ?q=lat,lng format: ?q=51.5074,-0.1278
    - ?ll=lat,lng format: ?ll=52.520008,13.404954
    - ?center=lat,lng format: ?center=40.7128,-74.0060
  - Validates coordinates are within valid geographic ranges (lat: -90 to 90, lng: -180 to 180)
  - Returns null if coordinates cannot be extracted or are invalid
  - isValidCoordinate() helper function for validation
  - Error handling with try/catch
  - Integrated with paste handler in Layout.tsx
  - Console logs show "[Coordinates Extracted]" with lat/lng values
  - Updated test-urls.md with coordinate extraction examples
  - Build passes successfully
- [x] 4.4 Place Data Extraction (Basic) - src/lib/geocoding.ts
  - Created reverseGeocode() function using OpenStreetMap Nominatim API (free, no API key required)
  - Created forwardGeocode() function for address-to-coordinates conversion (for Phase 12)
  - PlaceInfo interface with name, address, displayName, lat, lng, placeType, city, country
  - Extracts place name from multiple Nominatim response fields (amenity, building, shop, tourism, etc.)
  - Builds formatted address from components (house_number, road, suburb, city, postcode, country)
  - Proper User-Agent header for Nominatim API compliance
  - Rate limiting note: 1 request per second (Nominatim usage policy)
  - Error handling with try/catch for network failures
  - Integrated with paste handler in Layout.tsx (async/await)
  - Console logs show "[Fetching place info...]" and "[Place Info Retrieved]" with name/address
  - Created geocoding.test-examples.md with test cases for Big Ben, Eiffel Tower, Sydney Opera House, Colosseum
  - Build passes successfully
- [x] 4.5 Place Data Extraction (Extended) - src/lib/maps.ts, src/lib/geocoding.ts
  - **Research findings**: Free APIs (Nominatim) cannot provide rating, hours, website, phone
    - Google Places API required for this data (paid, not in scope)
    - Decision: Extended fields will be user-provided in Phase 7 (Edit Place)
  - Added extractPlaceNameFromUrl() function to extract place names from Google Maps URLs
    - Parses /place/PlaceName/ format from URLs
    - URL-decodes the name (+ → space, %20 → space, etc.)
    - More accurate than geocoding for named places
  - Extended PlaceInfo interface with optional fields:
    - rating (number, 1-5 scale)
    - openingHours (string, free-form text)
    - website (string)
    - phone (string)
    - googleMapsUrl (string, original URL for tracking)
    - urlExtractedName (string, name from URL parsing)
  - Updated paste handler in Layout.tsx to:
    - Extract place name from URL first (prioritized over geocoded name)
    - Log comprehensive "[All Extracted Place Data]" object with all fields
    - Handle partial data when geocoding fails but URL has name
  - Updated maps.test-urls.md with place name extraction test cases
  - Build passes successfully
- [x] 4.6 Add to Collection Modal (UI) - src/components/AddPlaceModal.tsx
  - Created AddPlaceModal component with:
    - Place info card showing name, address, coordinates, and "View on Maps" link
    - Warm gradient card design (amber-50 to orange-50) matching app aesthetic
    - Collection dropdown selector with:
      - Fetches collections from database on modal open
      - Shows collection color/icon badge
      - Dropdown with selection state and checkmark
      - Handles empty state (no collections yet)
      - Handles loading state
    - Save and Cancel action buttons
  - ExtractedPlace interface defined for type-safe place data
  - Integrated with Layout.tsx:
    - Added isAddPlaceOpen, extractedPlace, isAddingPlace state
    - Paste handler now opens modal with extracted place data
    - handleSavePlace and handleCloseAddPlace handlers (save logic TODO in Phase 4.7)
  - Build passes successfully
- [x] 4.7 Save Place to Database - src/app/actions/places.ts
  - Created createPlace() server action to insert into places table
  - Created getPlaces() to fetch all non-deleted places
  - Created getPlacesByCollection() to fetch places for a collection
  - Place interface matches database schema (id, collection_id, name, address, lat, lng, etc.)
  - Uses getOrCreateDefaultCollection() if no collection specified
  - Integrated with Layout.tsx handleSavePlace handler
  - Console logs show "[Place Saved Successfully]" on save
  - Build passes successfully
- [x] 4.8 Success Feedback - src/components/Toast.tsx
  - Created Toast component with success/error variants
  - ToastContainer for managing multiple toasts
  - Auto-dismiss after 4 seconds with manual dismiss option
  - Animated entrance/exit transitions
  - Success toast: green with checkmark icon
  - Error toast: red with X icon
  - Integrated with Layout.tsx via showToast() and dismissToast()
  - Shows "Place added to your collection!" on successful save
  - Build passes successfully
- [x] 4.9 Error Handling - src/components/Layout.tsx
  - Added error toasts for various failure scenarios:
    - Geocoding failure with partial data: allows saving with warning
    - Geocoding failure without name: shows error, suggests manual entry
    - No coordinates in URL: suggests trying different link
  - Non-Maps URLs are silently ignored (no spam on normal paste)
  - Save failures show error toast with message
  - Build passes successfully

### Phase 3: Collections (COMPLETE)
- [x] 3.1 Color Palette - src/lib/colors.ts and src/components/ColorPicker.tsx
  - 16 curated colors: warm (red, orange, amber, yellow), cool (lime, green, teal, cyan), blues/purples (blue, indigo, violet, purple), pinks/neutrals (pink, rose, stone, slate)
  - ColorPicker component: 8-column grid, selection state with checkmark, hover/focus animations
  - Helper functions: findColorByValue(), getContrastColor()
  - Default color: Amber (matches app accent)
- [x] 3.2 Icon Set Curation - src/lib/icons.ts
  - lucide-react already installed from Phase 2.1
  - 76 curated place-related icons organized by category
  - Categories: General, Food & Drink, Shopping, Entertainment, Recreation, Travel, Health, Education, Home, Nature, Services
  - Helper functions: findIconByName(), getIconCategories(), getIconsByCategory()
  - Default icon: MapPin
- [x] 3.3 Icon Picker Component - src/components/IconPicker.tsx
  - Scrollable grid (max-h-64) with 8-column layout
  - Search functionality to filter icons by name/category
  - Category filter pills for quick filtering
  - Selection state with checkmark badge
  - Supports custom accent color via prop
  - Icons grouped by category with headers
- [x] 3.4 Create Collection UI - src/components/Modal.tsx, src/components/NewCollectionModal.tsx
  - Reusable Modal component with backdrop, close-on-escape, accessibility
  - NewCollectionModal with name input, ColorPicker, IconPicker
  - Live preview of collection (color + icon + name)
  - Form validation (name required)
  - Submit/Cancel buttons with loading state
- [x] 3.5 Create Collection Save - src/app/actions/collections.ts
  - Server action createCollection() inserts into Supabase collections table
  - Added "New Collection" button to Layout header
  - Modal closes on successful creation
  - onCollectionCreated callback for parent refresh
- [x] 3.6 Fetch Collections - src/app/actions/collections.ts
  - Server action getCollections() fetches all collections
  - Orders by created_at descending (newest first)
- [x] 3.7 Display Collections - src/components/CollectionsList.tsx
  - Desktop: Always-visible sidebar (320px) with collections list
  - Mobile: Collections button opens slide-up panel
  - Shows name, color swatch with icon for each collection
  - Selection state highlighting
  - Empty state with "Create your first collection" prompt
  - Auto-refreshes when new collection is created
- [x] 3.8 Default Collection - src/app/actions/collections.ts
  - Added getOrCreateDefaultCollection() function
  - Default collection: "My Places" with Amber color and MapPin icon
  - Returns existing collection if any exist, creates default otherwise
  - Ready for use in Phase 4 when adding places

### Phase 0: Project Setup (COMPLETE)
- [x] 0.1 Initialize Next.js with App Router (commit: 1b205b7)
- [x] 0.2 Tailwind CSS configured and tested
- [x] 0.3 Environment & Git setup (.env.local.example created)
- [x] 0.4 Project structure created (components/, lib/, app/)
- [x] 0.5 Supabase client setup (lib/supabase.ts) (commit: 05922ea)
- [x] 0.6-0.9 Database schema created:
  - settings table (key, value)
  - collections table (id, name, color, icon, timestamps)
  - places table (all fields per schema)
  - tags table (id, name)
  - place_tags junction table (place_id, tag_id)

### Phase 1: Map Foundation (COMPLETE)
- [x] 1.1 Mapbox Setup - installed mapbox-gl@3.18.0 and react-map-gl@8.1.0
- [x] 1.2 Basic Map component - components/Map.tsx, centered on London (51.5074, -0.1278)
- [x] 1.3 Map styling - using mapbox://styles/mapbox/light-v11, fills viewport
- [x] 1.4 Responsive layout shell - components/Layout.tsx with flex layout
- [x] 1.5 Empty state overlay - components/EmptyState.tsx with prompt message

### Phase 2: Password Protection (COMPLETE)
- [x] 2.1 Password Setup Screen - src/app/setup/page.tsx
  - Form with password and confirm password inputs
  - Show/hide password toggle using lucide-react icons
  - Validation: minimum 8 characters, passwords must match
  - Glass-morphism design with amber accent color
  - Installed lucide-react package
- [x] 2.2 Password Hashing - src/lib/auth.ts
  - Using Web Crypto API with PBKDF2 (no external dependencies)
  - 100,000 iterations, SHA-256 hash, 256-bit key
  - Random 16-byte salt per password
  - Hash format: salt:hash (hex encoded)
  - Constant-time comparison to prevent timing attacks
  - Functions: hashPassword(), verifyPassword()
- [x] 2.3 Store Password Hash - src/app/setup/actions.ts
  - Server action setupPassword() hashes and saves to settings table
  - Server action isPasswordSet() checks if password exists
  - Setup form connected to server action with error handling
  - Redirects to main page on success
- [x] 2.4 Password Entry Screen - src/app/login/page.tsx
  - Login form with password input and submit button
  - Show/hide password toggle
  - Error display for failed login attempts
  - Matches setup page design aesthetic
- [x] 2.5 Password Verification - src/app/login/actions.ts
  - Server action verifyPasswordAction() fetches hash from settings table
  - Uses verifyPassword() from lib/auth.ts for constant-time comparison
  - Returns success/error object to client
  - Login form wired to server action with error handling
  - Incorrect password shows user-friendly error message
  - Correct password redirects to main page (session token to be added in 2.6)
- [x] 2.6 Session Token - src/lib/auth.ts
  - Added generateSessionToken() using crypto.getRandomValues (32 bytes, 256 bits)
  - Converts to URL-safe base64 format
  - Added setSessionToken(), getSessionToken(), clearSessionToken() for localStorage
  - Added isAuthenticated() helper to check if session exists
  - Login page now generates and stores token on successful authentication
  - Token is cryptographically secure and collision-resistant
- [x] 2.7 Auth State Check - src/lib/auth.ts
  - Already implemented in Phase 2.6 with isAuthenticated() function
  - Checks if session token exists in localStorage
  - Returns boolean for quick auth status checks
- [x] 2.8 Route Protection - src/components/AuthGuard.tsx
  - Created AuthGuard component to protect routes
  - Checks if password is set via isPasswordSet() server action
  - Redirects to /setup if no password exists
  - Checks authentication status via isAuthenticated()
  - Redirects to /login if not authenticated
  - Shows loading spinner during auth check
  - Wrapped root layout with AuthGuard for app-wide protection
  - Public routes (/setup, /login) bypass auth check
- [x] 2.9 Logout - src/components/Layout.tsx
  - Added logout button in top-right corner with glass-morphism style
  - Button uses LogOut icon from lucide-react
  - Clicking logout clears session token via clearSessionToken()
  - Redirects to login page after logout
  - Styled to match existing UI aesthetic with backdrop blur and shadows

---

## Decisions Made

### Database
- Using Supabase (PostgreSQL) with free tier
- All tables created via Supabase dashboard/SQL editor
- Foreign key from places.collection_id → collections.id
- Soft delete via deleted_at timestamp on places

### Project Structure
- /src/app - Next.js App Router pages
- /src/components - React components
- /src/lib - Utility functions (supabase.ts, etc.)
- /docs - Documentation (roadmap.md, PRD.md, progress.txt)

### Map Implementation
- Using react-map-gl v8 with subpath import: `react-map-gl/mapbox`
- Map style: mapbox://styles/mapbox/light-v11 (clean, minimal)
- Initial zoom level: 11

### UI/Design
- Minimal, clean aesthetic
- Empty state overlay positioned at bottom center
- Glass-morphism style card (bg-white/95 with backdrop-blur)
- Responsive breakpoint at lg (1024px) for desktop side panel

---

## Blockers Encountered

### 2026-01-21 - react-map-gl import issue with Turbopack
**Problem**: Build failed with "Module not found: Can't resolve 'react-map-gl'"
**Why it failed**: react-map-gl v8 uses subpath exports, no default export
**Solution**: Changed import from `react-map-gl` to `react-map-gl/mapbox`

---

## Failed Approaches

### 2026-01-21 - Default react-map-gl import
**Problem**: `import MapGL from 'react-map-gl'` failed in Turbopack
**Why it failed**: react-map-gl v8 restructured exports to use subpaths
**Better approach**: Use `import { Map } from 'react-map-gl/mapbox'` for Mapbox GL

---

## Files Changed Log

### 2026-01-21
- Created: docs/progress.txt
- Modified: CLAUDE.md (added progress tracking instructions)
- Modified: package.json (added mapbox-gl, react-map-gl)
- Created: src/components/Map.tsx
- Created: src/components/Layout.tsx
- Created: src/components/EmptyState.tsx
- Modified: src/app/page.tsx (uses Layout, Map, EmptyState)
- Modified: src/app/layout.tsx (updated title and description)

### 2026-01-21 (Phase 2.1)
- Created: src/app/setup/page.tsx (password setup form)
- Modified: package.json (added lucide-react)

### 2026-01-21 (Phase 2.2)
- Created: src/lib/auth.ts (password hashing utilities)

### 2026-01-21 (Phase 2.3)
- Created: src/app/setup/actions.ts (server actions for password setup)
- Modified: src/app/setup/page.tsx (connected to server action)

### 2026-01-21 (Phase 2.4)
- Created: src/app/login/page.tsx (login form)

### 2026-01-21 (Phase 2.5)
- Created: src/app/login/actions.ts (password verification server action)
- Modified: src/app/login/page.tsx (connected to verifyPasswordAction)

### 2026-01-21 (Phase 2.6)
- Modified: src/lib/auth.ts (added session token functions)
- Modified: src/app/login/page.tsx (generate and store token on login)

### 2026-01-21 (Phase 2.7)
- Already completed in Phase 2.6 (isAuthenticated function)

### 2026-01-21 (Phase 2.8)
- Created: src/components/AuthGuard.tsx (route protection component)
- Modified: src/app/layout.tsx (wrapped with AuthGuard)

### 2026-01-21 (Phase 2.9)
- Modified: src/components/Layout.tsx (added logout button and handler)

### 2026-01-21 (Phase 3.1)
- Created: src/lib/colors.ts (16 preset colors for collection pins)
- Created: src/components/ColorPicker.tsx (color swatch grid with selection)

### 2026-01-21 (Phase 3.2)
- Created: src/lib/icons.ts (76 curated place-related icons)

### 2026-01-21 (Phase 3.3)
- Created: src/components/IconPicker.tsx (scrollable icon grid with search and filtering)

### 2026-01-21 (Phase 3.4)
- Created: src/components/Modal.tsx (reusable modal/dialog component)
- Created: src/components/NewCollectionModal.tsx (collection creation form)

### 2026-01-21 (Phase 3.5 & 3.6)
- Created: src/app/actions/collections.ts (server actions for collections CRUD)
- Modified: src/components/Layout.tsx (added New Collection button and modal integration)

### 2026-01-21 (Phase 3.7)
- Created: src/components/CollectionsList.tsx (collections sidebar with mobile panel)
- Modified: src/components/Layout.tsx (integrated CollectionsList with desktop sidebar and mobile slide-up)

### 2026-01-21 (Phase 3.8)
- Modified: src/app/actions/collections.ts (added getOrCreateDefaultCollection function)

### 2026-01-21 (Phase 4.1)
- Modified: src/components/Layout.tsx (added global paste event listener)

### 2026-01-21 (Phase 4.2)
- Created: src/lib/maps.ts (Google Maps URL detection utilities)
- Created: src/lib/maps.test-urls.md (test cases documentation)
- Modified: src/components/Layout.tsx (integrated Maps URL detection with paste listener)

### 2026-01-21 (Phase 4.3)
- Modified: src/lib/maps.ts (added coordinate extraction functions)
- Modified: src/lib/maps.test-urls.md (added coordinate extraction test cases)
- Modified: src/components/Layout.tsx (integrated coordinate extraction with paste handler)

### 2026-01-21 (Phase 4.4)
- Created: src/lib/geocoding.ts (reverse and forward geocoding with Nominatim API)
- Created: src/lib/geocoding.test-examples.md (test cases documentation)
- Modified: src/components/Layout.tsx (integrated reverse geocoding with paste handler)

### 2026-01-21 (Phase 4.5)
- Modified: src/lib/maps.ts (added extractPlaceNameFromUrl function)
- Modified: src/lib/geocoding.ts (extended PlaceInfo interface with optional fields)
- Modified: src/components/Layout.tsx (integrated place name extraction, comprehensive logging)
- Modified: src/lib/maps.test-urls.md (added place name extraction test cases)

### 2026-01-21 (Phase 4.6)
- Created: src/components/AddPlaceModal.tsx (modal for adding places from paste)
- Modified: src/components/Layout.tsx (integrated AddPlaceModal with paste handler)

### 2026-01-21 (Phase 4.7)
- Created: src/app/actions/places.ts (server actions for places CRUD)
- Modified: src/components/Layout.tsx (integrated createPlace with save handler)

### 2026-01-21 (Phase 4.8)
- Created: src/components/Toast.tsx (toast notification system)
- Modified: src/components/Layout.tsx (integrated toast notifications)

### 2026-01-21 (Phase 4.9)
- Modified: src/components/Layout.tsx (added error handling with toast feedback)

### 2026-01-21 (Phase 5.1-5.6)
- Modified: src/app/actions/places.ts (added getPlacesWithCollections, PlaceWithCollection interface)
- Created: src/components/MapMarker.tsx (custom colored pin with icon)
- Modified: src/components/Map.tsx (accepts places, renders markers, fits bounds, handles clicks)
- Modified: src/app/page.tsx (client component, fetches places, passes to Map)
- Modified: src/components/Layout.tsx (added onPlaceAdded callback prop)

### 2026-01-21 (Phase 6.1-6.10)
- Created: src/components/PlaceDetailsPanel.tsx (responsive place details panel)
- Modified: src/app/page.tsx (added panel state, marker click opens panel)

### 2026-01-21 (Phase 7.1-7.11)
- Modified: src/app/actions/places.ts (added updatePlace, softDeletePlace, restorePlace, permanentlyDeletePlace, tag functions)
- Created: src/components/TagInput.tsx (tag input with chips)
- Created: src/components/EditPlaceModal.tsx (edit place modal with tags and collection dropdown)
- Modified: src/components/PlaceDetailsPanel.tsx (added edit button, tags display, Tag type import)
- Modified: src/app/page.tsx (integrated EditPlaceModal, tags fetching)
- Created: src/app/trash/page.tsx (trash view with restore/delete)
- Modified: src/components/Layout.tsx (added Trash button)

### 2026-01-22 (Phase 8.1-8.6)
- Created: src/components/EditCollectionModal.tsx (edit/delete collection modal)
- Modified: src/app/actions/collections.ts (added updateCollection, deleteCollection, getCollectionPlaceCounts)
- Modified: src/components/CollectionsList.tsx (added edit/focus buttons, place counts)
- Modified: src/components/Layout.tsx (integrated EditCollectionModal, onFocusCollection)
- Modified: src/components/Map.tsx (added focusCollectionId, focusTrigger props)
- Modified: src/app/page.tsx (added handleFocusCollection, focusCollectionId state)

### 2026-01-22 (Phase 9.1-9.9 & Phase 10.1-10.6)
- Created: src/components/FilterBar.tsx (collection/tag filter dropdowns, search bar, clear button)
- Created: src/components/ViewToggle.tsx (map/list view toggle button)
- Created: src/components/ListView.tsx (list view with grouping, sorting, item selection)
- Modified: src/app/page.tsx (integrated filters, search, view toggle, list view)
  - Added filter state (selectedCollections, selectedTags, searchQuery)
  - Added placeTagsMap for efficient tag filtering
  - Added filteredPlaces memoized computation
  - Added viewMode state for map/list toggle
  - Connected collection/tag clicks in panel to filter actions
  - Parallel data fetching for places, collections, and tags

### 2026-01-22 (Phase 11.1-11.3)
- Created: src/components/ContextMenu.tsx (context menu component)
- Modified: src/components/MapMarker.tsx (added onContextMenu, touch handlers for long press)
- Modified: src/components/Map.tsx (added onMarkerContextMenu prop)
- Modified: src/app/page.tsx (added context menu state and handlers)

### 2026-01-22 (Phase 12.1-12.4)
- Created: src/components/ManualPlaceModal.tsx (manual place entry form)
- Modified: src/components/Layout.tsx (added manual place button and modal integration)

### 2026-01-22 (Phase 13.1-13.3)
- Modified: src/app/actions/places.ts (added duplicate detection functions)
  - calculateDistance() for Haversine formula
  - checkDuplicateByCoordinates() for ~50m proximity check
  - checkDuplicateByUrl() for exact URL match
  - checkForDuplicates() combines both checks
- Created: src/components/DuplicateWarningModal.tsx (duplicate warning UI)
- Modified: src/components/Layout.tsx (integrated duplicate detection)

---

## Learnings

### Web Crypto API for Password Hashing
- PBKDF2 is available natively in browsers and Node.js via Web Crypto API
- No need for external packages like bcrypt
- Use salt.buffer as ArrayBuffer when passing to crypto.subtle.deriveBits()
- TypeScript strict mode requires explicit type casting for ArrayBuffer

### react-map-gl v8 Breaking Changes
- v8 uses ES module subpath exports
- Import from `react-map-gl/mapbox` for Mapbox GL JS
- Import from `react-map-gl/maplibre` for MapLibre GL JS
- The Map component is named export, not default: `{ Map }`

### Next.js 16 with Turbopack
- Turbopack has stricter module resolution than Webpack
- Some npm packages may need specific import paths
- Build errors often more informative than dev server errors

---

### 2026-01-22 (Phase 14.1-14.7)
- Created: public/manifest.json (PWA manifest with share target)
- Created: public/sw.js (service worker)
- Created: public/icons/icon.svg (source icon)
- Created: public/icons/icon-192.png, icon-512.png (generated icons)
- Created: public/icons/icon-maskable-192.png, icon-maskable-512.png (maskable icons)
- Created: public/icons/apple-touch-icon.png, favicon-16.png, favicon-32.png
- Created: scripts/generate-icons.mjs (icon generation script)
- Created: scripts/generate-icons.html (alternative browser-based generator)
- Created: src/components/ServiceWorkerRegistration.tsx (SW registration)
- Created: src/components/InstallPrompt.tsx (PWA install banner)
- Created: src/app/share/page.tsx (share target handler)
- Modified: src/app/layout.tsx (manifest link, viewport, SW registration)
- Modified: src/app/page.tsx (shared place handling, Suspense wrapper)
- Modified: src/components/Layout.tsx (paste button, shared place props)

### 2026-01-22 (Phase 15.1-15.6)
- Modified: src/components/Toast.tsx (added 'info' toast type with blue styling)
- Modified: src/components/ListView.tsx (improved empty states with filter context)
- Modified: src/components/PlaceDetailsPanel.tsx (added "No tags" placeholder)
- Modified: src/components/FilterBar.tsx (accessibility attributes, keyboard support)
- Modified: src/components/MapMarker.tsx (accessibility: role, tabIndex, aria-label, keyboard)
- Modified: src/components/Map.tsx (pass placeName to MapMarker)
- Modified: src/app/page.tsx (refreshing indicator, soft limit warning, hasActiveFilters)

---

### 2026-01-23 (Bug Fix: Trash in Mobile Panel)
- Modified: src/components/Layout.tsx
  - Added import for TrashPlacesList and getDeletedPlaces
  - Added state: showTrash (boolean), trashPlaces (PlaceWithCollection[])
  - Added handlers: handleSelectTrash, handleTrashBack, handleTrashPlacesChanged
  - Updated panel rendering to show TrashPlacesList when showTrash is true
  - Added onSelectTrash prop to CollectionsList
  - Reset trash state when closing panel via backdrop click
- Root cause: After removing SidePanel.tsx (desktop sidebar), the mobile panel lost Trash functionality because onSelectTrash was no longer being passed to CollectionsList

---

### 2026-01-23 (Bug Fix: Android Share Target Not Appearing)
- Modified: public/sw.js
  - Fixed duplicate fetch event listeners - merged into a single handler
  - Added early check for `/share` path to let share target requests pass through without caching
  - Incremented cache version from `matchbook-v1` to `matchbook-v2` to force update
- Root cause: Two issues:
  1. Android reads `share_target` from manifest only at PWA install time - existing PWA installs from before share_target was added won't see it
  2. Service worker had two fetch listeners; the first one (caching) intercepted all GET requests before the share handler could execute
- User action required: Uninstall PWA and reinstall to pick up manifest share_target config

---

### 2026-01-24 (Bug Fix: Google Maps Coordinate Extraction)
- Problem: Wrong addresses displayed when importing Google Maps links
  - Example: `https://maps.app.goo.gl/znBhk179A1MR4WtQA` showed "45 Danby Street" instead of "161 Bellenden Rd"
  - Root cause: The `/@lat,lng` regex matched the VIEWPORT/camera center, not the actual PLACE coordinates
- Solution implemented:
  - Created: src/lib/distance.ts (Haversine formula for distance calculation)
  - Modified: src/lib/maps.ts
    - Reordered coordinate extraction priority: `!3d!4d` > `?q=` > `?ll=` > `/@` > `?center=`
    - Added logic to prefer !3d!4d coords that differ from @ coords (place vs viewport)
  - Modified: src/lib/geocoding.ts
    - Added smartGeocode() function that validates coordinates against place name
    - If forward-geocoded place is >500m from extracted coords, uses forward-geocoded location instead
    - Handles all cases: both name+coords, only coords, only name, neither
  - Modified: src/components/Layout.tsx
    - Updated paste button handler and global paste listener to use smartGeocode()
    - Simplified code by removing redundant fallback logic (now handled by smartGeocode)
  - Modified: src/app/share/page.tsx
    - Updated share target handler to use smartGeocode()
- Verification: Build passes successfully

---

### 2026-01-25 (Enhancement: Google Maps Scraping with Puppeteer)
- Problem: Addresses extracted via Nominatim differ from Google Maps addresses - user wants EXACT match
- Solution: Implemented Puppeteer-based scraping to render Google Maps page and extract exact address

#### Changes Made:
- Installed: puppeteer (for headless Chrome scraping)
- Created: src/lib/google-maps-scraper.ts
  - `expandAndScrapeGoogleMapsUrl()` - expands shortened URLs and scrapes place data
  - Uses Puppeteer to render the page fully (handles JavaScript-loaded content)
  - Handles Google consent page by clicking "Accept" button
  - Extracts from DOM: name (h1), address (button[data-item-id="address"]), phone, website, hours
  - Singleton browser instance with auto-close after 60s inactivity
- Modified: src/app/actions/urls.ts
  - Added `scrapeGoogleMapsUrl()` server action for full URL scraping
  - `expandShortenedMapsUrl()` now uses Puppeteer first, falls back to fetch if it fails
  - Returns additional fields: scrapedPhone, scrapedWebsite, scrapedHours
- Modified: src/lib/geocoding.ts
  - Extended SmartGeocodeOptions with `scrapedName` and `scrapedAddress` parameters
  - smartGeocode() uses scraped address when available, skips Nominatim call
- Modified: src/components/Layout.tsx
  - Updated paste handlers to pass scraped data to smartGeocode()
- Modified: src/app/share/page.tsx
  - Updated share target handler to pass scraped data
- Created: docs/link-extractor-test-cases.json
  - Test URLs with expected exact addresses from Google

#### Tested Results (all exact matches):
- Skehans → "1 Kitto Rd, London SE14 5TW"
- Guacamoles → "48 Rye Ln, London SE15 5BY"
- Lao Dao → "305 Walworth Rd, London SE17 2TG"
- Sambal Shiok Laksa Bar → "171 Holloway Rd, London N7 8LX"

#### Notes:
- Puppeteer adds ~76 packages and requires headless Chrome
- May need additional config for Vercel deployment (@sparticuz/chromium)
- Falls back to fetch-based extraction if Puppeteer fails

---

### 2026-01-25 (Vercel Deployment Prep: Puppeteer + Cleanup)

#### Problem: Standard Puppeteer doesn't work on Vercel serverless functions
- Vercel's serverless environment doesn't have Chrome installed
- Need `@sparticuz/chromium` for serverless-compatible Chromium

#### Changes Made:

1. **Installed dependencies:**
   - `@sparticuz/chromium` - Serverless-compatible Chromium binary
   - `puppeteer-core` - Puppeteer without bundled Chromium

2. **Modified: src/lib/google-maps-scraper.ts**
   - Changed import from `puppeteer` to `puppeteer-core`
   - Added import for `@sparticuz/chromium`
   - Updated `getBrowser()` to detect production vs development:
     - Production: Uses `@sparticuz/chromium` with `chromium.args` and `chromium.executablePath()`
     - Development: Uses system Chrome with platform-specific paths (macOS, Windows, Linux)

3. **Modified: src/lib/geocoding.ts**
   - Updated file header comment to reflect new purpose (forward geocoding only)
   - Removed `reverseGeocode()` function (no longer needed - Puppeteer provides exact addresses)
   - Removed `delay()` helper (was only used for Nominatim rate limiting)
   - Updated `smartGeocode()` to remove reverseGeocode fallback
   - Removed `'reverse_geocode'` from `SmartGeocodeResult.source` type

4. **Modified: docs/prd.md**
   - Added "How Place Data Extraction Works" section documenting:
     - Puppeteer-based scraping for pasted Google Maps links
     - DOM selectors used (h1, button[data-item-id="address"], etc.)
     - Nominatim forward geocoding for manual place entry
     - Note about @sparticuz/chromium for Vercel compatibility

#### Verification:
- Build passes (`npm run build`)

---

### 2026-01-26 (Bug Fix: Google Maps Place Extraction Issues)

#### Root Cause Analysis (After Investigation)

**Android URL (`maps.app.goo.gl/SckhMyXSB3Yjn6Zz7`):**
- Redirects to consent page, continue URL: `/place/The+Gluten+Free+Bakery,+58+Chadwick+Rd,+London+SE15+4PU/data=...`
- **NO `!3d!4d` coordinates in the URL at all** - the issue wasn't wrong coords, they were missing entirely
- Address is embedded in the URL path as part of the place name
- Solution: Extract address from URL path and forward geocode to get coordinates

**Desktop URL (`maps.app.goo.gl/Bnp5Tf3mmosUFYAX6`):**
- Redirects to consent page, continue URL: `/@51.4680721,-0.0749573,17z/data=...!3d51.4680721!4d-0.0749573`
- Coordinates are correct (London: 51.46°N, 0.07°W) ✅
- Address not in URL path - would need DOM scraping, but consent page blocks this

#### Solution Implemented

**1. New URL extraction function (src/lib/maps.ts)**
- Added `extractPlaceInfoFromUrl()` to extract BOTH name AND address from URL path
- Handles Android-style URLs: `/place/Name,+Address,+City+Postcode/...`
- Returns `{ name: string, address: string | null }`

**2. Improved consent page handling (src/lib/google-maps-scraper.ts)**
- When landing on consent page, extract the `continue` URL parameter
- Navigate directly to continue URL, bypassing consent
- Falls back to parsing continue URL for data extraction if navigation fails

**3. Updated server action (src/app/actions/urls.ts)**
- Added `urlExtractedAddress` field alongside `scrapedAddress`
- When DOM scraping fails, fall back to URL path extraction
- Uses `extractPlaceInfoFromUrl()` to get address from URL

**4. Updated paste handlers (Layout.tsx, share/page.tsx)**
- Use `urlExtractedAddress` as fallback when `scrapedAddress` is null
- Both paste button and global paste listener updated

**5. Updated smart geocoding (src/lib/geocoding.ts)**
- When no coordinates available, forward geocode the ADDRESS (not just name)
- Priority: scraped/URL address > place name
- "58 Chadwick Rd, London SE15 4PU" → forward geocode → London coords

#### Test Results (Debug Script Verified)
- **Android URL**: name="The Gluten Free Bakery", address="58 Chadwick Rd, London SE15 4PU" ✅
  - No coords in URL, will forward geocode address to get London location
- **Desktop URL**: coords=51.46°N, 0.07°W (London) ✅, name="The Gluten Free Bakery" ✅
  - Has correct coordinates, address can use forward geocoding as fallback

#### Files Modified:
- src/lib/maps.ts - Added extractPlaceInfoFromUrl(), improved coordinate extraction
- src/lib/google-maps-scraper.ts - Consent URL extraction, improved consent handling
- src/app/actions/urls.ts - urlExtractedAddress field, URL extraction fallback
- src/components/Layout.tsx - Use urlExtractedAddress fallback
- src/app/share/page.tsx - Use urlExtractedAddress fallback
- src/lib/geocoding.ts - Geocode address when no coordinates

#### Verification:
- Build passes successfully
- Debug script confirms correct extraction from both test URLs

---

### 2026-01-26 (Major Refactor: Migrate to Google Maps Places API)

#### Problem
The previous place extraction system was unreliable. Despite multiple strategies (URL coordinate parsing, Puppeteer DOM scraping, Nominatim geocoding), places still appeared in wrong locations (e.g., London place appearing in Scotland).

**Root causes:**
- URL coordinate extraction picked up viewport coordinates instead of actual place coordinates
- Puppeteer scraping failed on consent pages
- Nominatim reverse geocoding returned different addresses than Google Maps
- Too many fallback strategies with inconsistent results

#### Solution Implemented
Replaced the entire extraction mechanism with **Google Maps Places API** - the authoritative source for place data.

**Files Created:**
- src/lib/google-places.ts - Places API client with:
  - extractPlaceIdFromUrl() - Extract Place ID from various URL formats
  - extractPlaceNameFromUrl() - Extract place name from URL path
  - getPlaceDetails() - Fetch place details from Places API
  - searchPlace() - Text Search API for queries without Place ID
  - extractCoordinatesFromUrl() - Extract coords for search location bias

- src/app/actions/places-api.ts - Server actions:
  - extractPlaceFromUrl() - Main function for URL-based extraction
  - searchPlaceByText() - For manual place entry

**Files Modified:**
- src/components/Layout.tsx - Updated paste handlers to use extractPlaceFromUrl
- src/app/share/page.tsx - Updated share target to use extractPlaceFromUrl
- src/app/actions/urls.ts - Simplified to only URL expansion (no Puppeteer)
- src/lib/maps.ts - Removed coordinate extraction functions (kept URL detection)
- .env.local.example - Added GOOGLE_MAPS_API_KEY
- docs/prd.md - Updated extraction documentation

**Files Deleted:**
- src/lib/google-maps-scraper.ts - Puppeteer scraping (no longer needed)
- src/lib/geocoding.ts - Nominatim geocoding (replaced by Places API)

#### Benefits
1. **Accuracy**: Place data comes directly from Google Maps
2. **Simplicity**: Single source of truth instead of multiple fallbacks
3. **Reliability**: No more consent page issues or DOM scraping fragility
4. **Cost**: Within $200/month free tier (~$1-3/month for personal use)

#### Verification
- TypeScript compilation passes
- Production build succeeds
- All unit tests pass

---

### Phase 17.1: GPS Location (COMPLETE)
- [x] useGeolocation hook - src/hooks/useGeolocation.ts
  - Auto-requests location permission on mount
  - Uses watchPosition for continuous tracking
  - Returns: location (lat/lng), error, permissionDenied, isLoading
  - Cleanup on unmount (clears watcher)
  - High accuracy mode with 10s timeout, 30s cache
- [x] UserLocationMarker - src/components/UserLocationMarker.tsx
  - Pulsing blue dot (Mapbox Marker)
  - Uses Tailwind animate-ping for pulse effect
  - White border with blue shadow
- [x] Map component updates - src/components/Map.tsx
  - Added userLocation prop
  - Added MapHandle interface with flyToUserLocation()
  - Uses forwardRef + useImperativeHandle
  - Renders UserLocationMarker when location available
- [x] Layout button - src/components/Layout.tsx
  - "My Location" button with Locate icon (lucide-react)
  - Positioned next to Paste Link button
  - States: disabled (permission denied), gray (no location), blue (location available)
  - Shows toast when clicked with permission denied or no location
- [x] Page wiring - src/app/page.tsx
  - Added mapRef with MapHandle type
  - Integrated useGeolocation hook
  - Passes userLocation and callbacks through Layout to Map

---

### 2026-01-27 (Enhancement: API Data Pipeline & PlaceDetailsPanel UI)

#### Problem
Google Places API was returning additional data (rating, website, phone, opening hours, types, userRatingsTotal) but this data was not being passed through the pipeline and stored in the database. The PlaceDetailsPanel also needed UI enhancements to display this data properly.

#### Solution Implemented

**1. Extended ExtractedPlace interface (src/components/AddPlaceModal.tsx)**
- Added: types, website, phone, rating, userRatingsTotal, openingHours

**2. Extended Place and CreatePlaceInput interfaces (src/app/actions/places.ts)**
- Added to Place: user_ratings_total, types
- Added to CreatePlaceInput: openingHours, userRatingsTotal, types
- Updated createPlace() to use all new fields when inserting

**3. Updated Layout.tsx**
- savePlaceFromPaste() now passes all API fields to createPlace()
- Both paste handlers (button click & global listener) include all API data when building ExtractedPlace

**4. Updated places-api.ts**
- Extended ExtractPlaceResult.place to include userRatingsTotal
- Both extractPlaceFromUrl() and searchPlaceByText() now return userRatingsTotal

**5. Enhanced PlaceDetailsPanel UI (src/components/PlaceDetailsPanel.tsx)**
- Added formatPlaceType() helper to format "italian_restaurant" → "Italian Restaurant"
- Added getOpeningStatus() helper to parse opening hours and determine current status
- Place types shown below name (first 3 types, dot-separated)
- Rating now shows 5 visual stars (filled/empty) + numeric value + review count
- Opening hours are expandable/collapsible with:
  - Open/Closed status indicator
  - Today's hours shown by default
  - Full week schedule when expanded
  - Current day highlighted
- Added ChevronDown icon import for expandable hours

**6. Database Columns Required (user action)**
- `user_ratings_total` - integer, nullable
- `types` - text array, nullable

SQL to run in Supabase:
```sql
ALTER TABLE places ADD COLUMN user_ratings_total INTEGER;
ALTER TABLE places ADD COLUMN types TEXT[];
```

#### Files Modified:
- src/components/AddPlaceModal.tsx - Extended ExtractedPlace interface
- src/app/actions/places.ts - Extended interfaces, updated createPlace()
- src/components/Layout.tsx - Pass all API fields through
- src/app/actions/places-api.ts - Include userRatingsTotal in results
- src/components/PlaceDetailsPanel.tsx - Enhanced UI with types, stars, expandable hours

#### Verification:
- TypeScript compilation passes
- No lint errors in modified files
- User needs to add DB columns before testing

---

---

### 2026-01-27 (Enhancement: Back Button Navigation for Panels)

#### Problem
The browser/Android back button had no effect on panel states - pressing it while viewing a place or collection would either do nothing or close the app entirely.

#### Solution Implemented

**1. Created useHistoryNavigation hook (src/hooks/useHistoryNavigation.ts)**
- Manages browser History API (pushState, replaceState, popstate events)
- Tracks navigation stack: 'map' | 'collections' | 'collection' | 'place'
- Stores context about where user came from (e.g., which collection when viewing a place)
- Clears stale history state on page refresh for graceful recovery

**2. Updated Layout.tsx**
- Added historyNav, collectionsOpen, drilledCollectionId props
- Collections button pushes { view: 'collections' } to history
- Drilling into collection pushes { view: 'collection', collectionId }
- Going back via button replaces state to { view: 'collections' }
- Closing panel via backdrop clears history state
- onPlaceClick now passes fromCollectionId to track source
- External control props allow parent to control panel state on back navigation

**3. Updated page.tsx (HomeContent)**
- Integrated useHistoryNavigation hook with callbacks for each navigation type
- Opening place from map pushes { view: 'place', source: 'map' }
- Opening place from collection pushes { view: 'place', source: 'collection', collectionId }
- Back button callbacks close panels and navigate to appropriate views
- Manual panel close updates history state appropriately

#### Navigation Behavior
| Current State | Back Button Action |
|--------------|-------------------|
| Collection places list | → Collections list |
| Collections list | → Close panel (map view) |
| Place from collection | → Back to that collection |
| Place from map pin | → Close panel (map view) |

#### Edge Cases Handled
- Page refresh clears stale history state
- Duplicate history pushes prevented
- Manual close (not via back) updates history appropriately
- Rapid back presses handled via state tracking

#### Files Created:
- src/hooks/useHistoryNavigation.ts

#### Files Modified:
- src/components/Layout.tsx
- src/app/page.tsx

#### Verification:
- TypeScript build passes
- All navigation flows work correctly

---

---

### 2026-01-27 (Enhancement: Playwright E2E Testing Setup)

#### Purpose
Add end-to-end testing infrastructure to test user interactions on new features.

#### Changes Made

**1. Installed dependencies:**
- `@playwright/test` - Playwright test framework
- Chromium browser binary via `npx playwright install chromium`

**2. Created Playwright configuration (playwright.config.ts)**
- Test directory: `tests/e2e/`
- Base URL: `http://localhost:3000`
- Projects: Desktop Chrome, Mobile Chrome (Pixel 5)
- webServer config to auto-start Next.js dev server

**3. Created test structure:**
- tests/e2e/fixtures/auth.ts - Auto-login fixture using TEST_PASSWORD env var
- tests/e2e/fixtures/test-helpers.ts - Helper functions (waitForMapLoad, openCollectionsPanel, etc.)
- tests/e2e/back-button.spec.ts - Initial tests for back button navigation

**4. Added data-testid attributes to components:**
- Layout.tsx: collections-button, collections-panel, collections-backdrop
- CollectionsList.tsx: collection-item
- CollectionPlacesList.tsx: collection-back-button, place-item
- PlaceDetailsPanel.tsx: place-details-panel

**5. Added npm scripts (package.json):**
- `test:e2e` - Run all tests headless
- `test:e2e:ui` - Run with Playwright UI
- `test:e2e:headed` - Run with visible browser

**6. Updated configuration files:**
- .gitignore - Added Playwright artifacts (/test-results/, /playwright-report/, etc.)
- .env.local.example - Added TEST_PASSWORD env var documentation
- CLAUDE.md - Added testing instructions section

#### Running Tests
```bash
# Run all tests
npm run test:e2e

# Run with UI
npm run test:e2e:ui

# Run headed (visible browser)
npm run test:e2e:headed
```

#### Environment Variable Required
Add `TEST_PASSWORD=your-app-password` to `.env.local`

#### Files Created:
- playwright.config.ts
- tests/e2e/fixtures/auth.ts
- tests/e2e/fixtures/test-helpers.ts
- tests/e2e/back-button.spec.ts

#### Files Modified:
- package.json
- .gitignore
- .env.local.example
- CLAUDE.md
- src/components/Layout.tsx
- src/components/CollectionsList.tsx
- src/components/CollectionPlacesList.tsx
- src/components/PlaceDetailsPanel.tsx

#### Verification:
- `npx playwright test --list` shows 8 tests across 2 projects

---

### 2026-01-27 (Bug Fix: Place Panel Appearing Behind Collections Panel)

#### Problem
After clicking a place inside a collection, the place details panel appeared BEHIND the collections panel instead of on top.

#### Root Cause
- Both panels had `z-50` z-index
- When both visible, DOM order determined stacking
- Collections panel (in Layout.tsx) came after `{children}` (containing PlaceDetailsPanel), so it appeared on top
- The `collectionsOpen` state from page.tsx remained `undefined` when clicking a place, so the collections panel didn't close

#### Solution Implemented
Two-part fix for robustness:

**1. Raised PlaceDetailsPanel z-index (immediate fix)**
- Changed `z-50` to `z-[60]` in PlaceDetailsPanel.tsx line 399
- Ensures place panel is always above collections panel

**2. Explicitly close collections from page.tsx (root cause fix)**
- Added `setCollectionsOpen(false)` in handleMarkerClick when `fromCollectionId` is provided
- This ensures the external prop takes precedence and closes the collections panel

#### Files Modified:
- src/components/PlaceDetailsPanel.tsx - Changed z-50 to z-[60]
- src/app/page.tsx - Added setCollectionsOpen(false) in handleMarkerClick

#### Verification:
- All back-button E2E tests pass (2 passed, 6 skipped)

---

### 2026-01-27 (Bug Fix: Android Status Bar Flashing on Back Button)

#### Problem
When pressing the back button on Android, the status bar (with camera cutout) and navigation bar briefly appeared for ~4 seconds, shrinking the interface vertically each time.

#### Root Cause
The Layout component used `h-screen` (100vh) for its height. On Android PWAs, when the back button (popstate event) fires:
1. The browser briefly shows/hides the system UI bars
2. This changes the available viewport height
3. `100vh` recalculates based on the changing viewport
4. The layout "jumps" as it resizes to match

This is a known issue with `vh` units on mobile browsers where the viewport height changes dynamically.

#### Solution Implemented
1. **Changed `h-screen` to `h-dvh`** in Layout.tsx
   - `dvh` (dynamic viewport height) handles dynamic viewport changes smoothly
   - `100dvh` = the current actual viewport height (updates smoothly)
   - vs `100vh` = viewport height when bars are hidden (causes jumping)

2. **Added `viewportFit: "cover"`** to viewport config in layout.tsx
   - Properly handles notches and safe areas on mobile devices

3. **Added CSS fallback** in globals.css for browsers without dvh support
   - Falls back to `100vh` for older browsers

#### Files Modified:
- src/components/Layout.tsx - Changed `h-screen` to `h-dvh`
- src/app/layout.tsx - Added `viewportFit: "cover"` to viewport config
- src/app/globals.css - Added `@supports not (height: 100dvh)` fallback

#### Verification:
- Build passes successfully

---

### 2026-01-28 (Bug Fix: Edit Modal Appearing Behind Place Panel)

#### Problem
When editing a place from the place details panel, the edit modal appeared behind the panel due to z-index ordering:
- PlaceDetailsPanel: z-[60]
- Modal (EditPlaceModal): z-50

#### Solution Implemented
Hide the place panel when the edit modal opens, and restore it when the modal closes. This provides cleaner UX than adjusting z-index values.

**1. Modified handleEditClick (src/app/page.tsx)**
- Added `setIsPanelOpen(false)` before opening edit modal
- Panel hides smoothly before modal appears

**2. Modified EditPlaceModal onClose handler (src/app/page.tsx)**
- Changed from just closing modal to also restoring panel
- `setIsEditModalOpen(false)` + `setIsPanelOpen(true)`
- Panel reappears after modal closes

**3. Added data-testid attributes for E2E testing**
- PlaceDetailsPanel.tsx: `data-testid="edit-place-button"` on edit button
- Modal.tsx: Added `testId` prop support + `data-testid` on panel, backdrop, and close button
- EditPlaceModal.tsx: Passes `testId="edit-place-modal"` to Modal

**4. Created E2E test (tests/e2e/edit-modal.spec.ts)**
- Tests that panel hides when edit modal opens
- Tests that panel restores when modal closes (via X button)
- Tests that panel restores when modal closes (via backdrop click)

#### Files Modified:
- src/app/page.tsx
- src/components/PlaceDetailsPanel.tsx
- src/components/Modal.tsx
- src/components/EditPlaceModal.tsx

#### Files Created:
- tests/e2e/edit-modal.spec.ts

#### Verification:
- Build passes
- E2E tests pass (2 passed, 10 skipped - skipped tests have no test data)

---

---

### 2026-01-29 (Bug Fix: Close Place Exits Collection Context)

#### Problem
When a user:
1. Tapped on a collection
2. Tapped on a place within that collection
3. Closed the place (via X button or tapping the map)

The map stayed filtered to show only places from that collection. The user expected closing the place to also exit the collection context, returning the map to show all places.

#### Root Cause
In `handleClosePanel()` (src/app/page.tsx), the function:
- Closed the place panel
- If opened from collection, replaced history state with collection view
- Did NOT clear `selectedCollections` state, so the map stayed filtered

#### Solution Implemented
Modified `handleClosePanel()` to clear all collection context when closing a place:
- Clear `selectedCollections` to `[]` (removes map filtering)
- Clear `drilledCollectionId` to `undefined` (closes collection drill-down)
- Set `collectionsOpen` to `false` (closes collections panel)
- Always call `historyNav.clearState()` instead of conditional logic
- Removed unused `placeOpenedFrom` dependency from dependency array

#### Files Modified:
- src/app/page.tsx - handleClosePanel() function (lines 294-311)

#### Verification:
- Build passes successfully

---

---

### 2026-01-29 (Enhancement: Replace Icon System with Emojis)

#### Purpose
Replace the Lucide icon system for collections with emojis. Emojis are more fun, universally recognizable, and render consistently across devices.

#### Changes Made

**1. Created emoji data and utilities (src/lib/emojis.ts)**
- ~88 place-relevant emojis organized by 10 categories
- Categories: General, Food & Drink, Shopping, Entertainment, Recreation, Travel, Health, Education, Nature, Services
- Functions: findEmojiByChar(), getEmojiCategories(), getEmojisByCategory(), isLegacyIconName()
- DEFAULT_EMOJI constant (📍 Pin)
- Legacy icon name detection for backwards compatibility

**2. Created EmojiPicker component (src/components/EmojiPicker.tsx)**
- Grid of emoji buttons with search functionality
- Category filter pills
- Selected state with checkmark badge
- Same structure as old IconPicker for consistency

**3. Updated all components to use emojis:**
- MapMarker.tsx - Renders emoji instead of Lucide icon
- CollectionsList.tsx - Shows emoji in collection row
- NewCollectionModal.tsx - Uses EmojiPicker, submits emoji character
- EditCollectionModal.tsx - Uses EmojiPicker, handles legacy icons
- PlaceDetailsPanel.tsx - Shows emoji in collection badge
- EditPlaceModal.tsx - Emoji in collection dropdown
- AddPlaceModal.tsx - Emoji in collection dropdown
- ManualPlaceModal.tsx - Emoji in collection dropdown
- CollectionPlacesList.tsx - Emoji in collection header
- ListView.tsx - Emoji in collection headers
- TrashPlacesList.tsx - Emoji in place rows
- ContextMenu.tsx - Emoji in "Move to" submenu
- DuplicateWarningModal.tsx - Emoji in existing place card
- src/app/trash/page.tsx - Emoji in trash item rows

**4. Updated server action (src/app/actions/collections.ts)**
- Uses DEFAULT_EMOJI.emoji for default collection creation

**5. Deleted old files:**
- src/lib/icons.ts - Old Lucide icon system
- src/components/IconPicker.tsx - Old icon picker component

#### Backwards Compatibility
- isLegacyIconName() detects old Lucide icon names (e.g., "Coffee", "Pin")
- Legacy names display fallback emoji (📍)
- Existing collections with old icon names will show 📍 until edited

#### Database Impact
- No schema changes required
- `icon` column now stores emoji character (e.g., "☕") instead of icon name
- Old icon names in DB are handled gracefully via fallback

#### Verification
- TypeScript compilation passes
- ESLint passes (no new errors)
- E2E tests pass (2 passed, 10 skipped)
- Production build succeeds

---

### 2026-01-29 (UI Simplification: Remove Colors, Filters, Tags, Notes)

#### Purpose
Simplify the Matchbook UI by removing several features while keeping the database unchanged. This makes the app cleaner and easier to use.

#### Features Removed from UI (DB columns kept for future re-enablement):
1. **Collection custom colors** - All circles/pins now white with border
2. **Filter functionality** - FilterBar component removed entirely
3. **Search functionality** - Part of filter removal
4. **Tags on places** - TagInput removed from UI
5. **Notes on places** - Notes field removed from UI

#### Files Deleted:
- src/components/FilterBar.tsx
- src/components/ColorPicker.tsx
- src/components/TagInput.tsx
- src/lib/colors.ts

#### Major Files Modified:
- src/app/page.tsx - Removed filter state, tags state, FilterBar
- src/components/Layout.tsx - Updated ManualPlaceModal handler signature
- src/components/EditPlaceModal.tsx - Removed TagInput, notes field
- src/components/ManualPlaceModal.tsx - Removed TagInput, notes field
- src/components/PlaceDetailsPanel.tsx - Removed tags/notes display
- src/components/NewCollectionModal.tsx - Removed ColorPicker
- src/components/EditCollectionModal.tsx - Removed ColorPicker
- src/app/actions/collections.ts - Removed colors.ts import, uses '#FFFFFF' for default

#### Color Styling Updates (all now use white with border):
- src/components/MapMarker.tsx
- src/components/CollectionsList.tsx
- src/components/CollectionPlacesList.tsx
- src/components/ListView.tsx
- src/components/AddPlaceModal.tsx
- src/components/TrashPlacesList.tsx
- src/components/DuplicateWarningModal.tsx
- src/components/ContextMenu.tsx
- src/app/trash/page.tsx

#### Documentation Updated:
- docs/prd.md - Moved colors, filters, tags, notes to Future Features section
- docs/progress.txt - This entry

#### Re-enabling Features in Future:
To re-enable any of these features:
1. Database columns still exist (notes, tags table, collection.color)
2. Restore component files from git history
3. Add back state management in page.tsx
4. Update components to use colors/tags/notes again

#### Verification:
- Build passes successfully (npm run build)

---

---

### 2026-01-29 (Feature Removal: Trash Functionality)

#### Purpose
Remove the trash feature from the UI to simplify the app. The database schema (`deleted_at` field) is preserved for potential future re-enablement.

#### Files Deleted:
- src/components/TrashPlacesList.tsx
- src/app/trash/page.tsx

#### Files Modified:
- src/components/EditPlaceModal.tsx - Removed delete UI, onDelete prop, Trash2 import
- src/components/CollectionsList.tsx - Removed trash section, onSelectTrash prop, trashCount state
- src/components/Layout.tsx - Removed TrashPlacesList import, trash state, trash handlers
- src/components/ContextMenu.tsx - Removed delete action, Trash2 import
- src/app/page.tsx - Removed softDeletePlace import, delete case, handleDelete callback, onDelete prop
- src/app/actions/places.ts - Removed softDeletePlace, restorePlace, permanentlyDeletePlace, getDeletedPlaces functions

#### Documentation Updated:
- docs/prd.md - Removed trash references, added to Future Features
- docs/roadmap.md - Noted trash removal in Phase 7
- docs/progress.txt - This entry

#### Re-enabling in Future:
To re-enable trash:
1. Database schema already supports it (`deleted_at` column exists)
2. Restore deleted files from git history
3. Re-add server actions to places.ts
4. Update components to use trash functionality again

#### Verification:
- Build passes successfully

---

## Next Steps (from roadmap.md)

1. Phase 16: Deployment (Vercel production testing)
   - Test with GOOGLE_MAPS_API_KEY configured in Vercel
   - Verify place extraction works with various URL types
   - Test GPS location on mobile devices

Note: Export & Import moved to future features.

Reference: docs/roadmap.md for full task breakdown
